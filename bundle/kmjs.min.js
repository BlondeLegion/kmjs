"use strict";const t=(t=0)=>e=>`[${e+t}m`,e=(t=0)=>e=>`[${38+t};5;${e}m`,n=(t=0)=>(e,n,r)=>`[${38+t};2;${e};${n};${r}m`,r={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};Object.keys(r.modifier);Object.keys(r.color),Object.keys(r.bgColor);const o=function(){const o=new Map;for(const[t,e]of Object.entries(r)){for(const[t,n]of Object.entries(e))r[t]={open:`[${n[0]}m`,close:`[${n[1]}m`},e[t]=r[t],o.set(n[0],n[1]);Object.defineProperty(r,t,{value:e,enumerable:!1})}return Object.defineProperty(r,"codes",{value:o,enumerable:!1}),r.color.close="[39m",r.bgColor.close="[49m",r.color.ansi=t(),r.color.ansi256=e(),r.color.ansi16m=n(),r.bgColor.ansi=t(10),r.bgColor.ansi256=e(10),r.bgColor.ansi16m=n(10),Object.defineProperties(r,{rgbToAnsi256:{value:(t,e,n)=>t===e&&e===n?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(e/255*5)+Math.round(n/255*5),enumerable:!1},hexToRgb:{value(t){const e=/[a-f\d]{6}|[a-f\d]{3}/i.exec(t.toString(16));if(!e)return[0,0,0];let[n]=e;3===n.length&&(n=[...n].map(t=>t+t).join(""));const r=Number.parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:t=>r.rgbToAnsi256(...r.hexToRgb(t)),enumerable:!1},ansi256ToAnsi:{value(t){if(t<8)return 30+t;if(t<16)return t-8+90;let e,n,r;if(t>=232)e=(10*(t-232)+8)/255,n=e,r=e;else{const o=(t-=16)%36;e=Math.floor(t/36)/5,n=Math.floor(o/6)/5,r=o%6/5}const o=2*Math.max(e,n,r);if(0===o)return 30;let i=30+(Math.round(r)<<2|Math.round(n)<<1|Math.round(e));return 2===o&&(i+=60),i},enumerable:!1},rgbToAnsi:{value:(t,e,n)=>r.ansi256ToAnsi(r.rgbToAnsi256(t,e,n)),enumerable:!1},hexToAnsi:{value:t=>r.ansi256ToAnsi(r.hexToAnsi256(t)),enumerable:!1}}),r}(),i=(()=>{if(!("navigator"in globalThis))return 0;if(globalThis.navigator.userAgentData){const t=navigator.userAgentData.brands.find(({brand:t})=>"Chromium"===t);if(t&&t.version>93)return 3}return/\b(Chrome|Chromium)\//.test(globalThis.navigator.userAgent)?1:0})(),a=0!==i&&{level:i},s={stdout:a,stderr:a};function l(t,e,n){let r=t.indexOf(e);if(-1===r)return t;const o=e.length;let i=0,a="";do{a+=t.slice(i,r)+e+n,i=r+o,r=t.indexOf(e,i)}while(-1!==r);return a+=t.slice(i),a}const{stdout:c,stderr:u}=s,d=Symbol("GENERATOR"),p=Symbol("STYLER"),g=Symbol("IS_EMPTY"),m=["ansi","ansi","ansi256","ansi16m"],y=Object.create(null),h=t=>{const e=(...t)=>t.join(" ");return((t,e={})=>{if(e.level&&!(Number.isInteger(e.level)&&e.level>=0&&e.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const n=c?c.level:0;t.level=void 0===e.level?n:e.level})(e,t),Object.setPrototypeOf(e,f.prototype),e};function f(t){return h(t)}Object.setPrototypeOf(f.prototype,Function.prototype);for(const[t,e]of Object.entries(o))y[t]={get(){const n=N(this,b(e.open,e.close,this[p]),this[g]);return Object.defineProperty(this,t,{value:n}),n}};y.visible={get(){const t=N(this,this[p],!0);return Object.defineProperty(this,"visible",{value:t}),t}};const k=(t,e,n,...r)=>"rgb"===t?"ansi16m"===e?o[n].ansi16m(...r):"ansi256"===e?o[n].ansi256(o.rgbToAnsi256(...r)):o[n].ansi(o.rgbToAnsi(...r)):"hex"===t?k("rgb",e,n,...o.hexToRgb(...r)):o[n][t](...r),S=["rgb","hex","ansi256"];for(const t of S){y[t]={get(){const{level:e}=this;return function(...n){const r=b(k(t,m[e],"color",...n),o.color.close,this[p]);return N(this,r,this[g])}}};y["bg"+t[0].toUpperCase()+t.slice(1)]={get(){const{level:e}=this;return function(...n){const r=b(k(t,m[e],"bgColor",...n),o.bgColor.close,this[p]);return N(this,r,this[g])}}}}const T=Object.defineProperties(()=>{},{...y,level:{enumerable:!0,get(){return this[d].level},set(t){this[d].level=t}}}),b=(t,e,n)=>{let r,o;return void 0===n?(r=t,o=e):(r=n.openAll+t,o=e+n.closeAll),{open:t,close:e,openAll:r,closeAll:o,parent:n}},N=(t,e,n)=>{const r=(...t)=>x(r,1===t.length?""+t[0]:t.join(" "));return Object.setPrototypeOf(r,T),r[d]=t,r[p]=e,r[g]=n,r},x=(t,e)=>{if(t.level<=0||!e)return t[g]?"":e;let n=t[p];if(void 0===n)return e;const{openAll:r,closeAll:o}=n;if(e.includes(""))for(;void 0!==n;)e=l(e,n.close,n.open),n=n.parent;const i=e.indexOf("\n");return-1!==i&&(e=function(t,e,n,r){let o=0,i="";do{const a="\r"===t[r-1];i+=t.slice(o,a?r-1:r)+e+(a?"\r\n":"\n")+n,o=r+1,r=t.indexOf("\n",o)}while(-1!==r);return i+=t.slice(o),i}(e,o,r,i)),r+e+o};Object.defineProperties(f.prototype,y);const C=f();f({level:u?u.level:0});let A=0;function I(){try{return`${require("os").homedir()}/Library/Logs/Keyboard Maestro/Engine.log`}catch(t){return console.warn("[km.engineLog] os module not available, using fallback path"),"/tmp/keyboard-maestro-engine.log"}}function M(){const t=I(),e=require("fs"),n="function"==typeof e.existsSync?e.existsSync:()=>!1,r="function"==typeof e.statSync?e.statSync:()=>({size:0});A=n(t)?r(t).size:0}function w(t){const e=I(),n=require("fs"),r="function"==typeof n.existsSync?n.existsSync:()=>!1,o="function"==typeof n.statSync?n.statSync:()=>({size:0}),i="function"==typeof n.openSync?n.openSync:null,a="function"==typeof n.readSync?n.readSync:null;if(!r(e)||!i||!a)return[];const s=o(e).size,l=A;if(s<=l)return A=s,[];const c=s-l,u=Buffer.alloc(c);a(i(e,"r"),u,0,c,l);const d=u.toString("utf8");A=s;return d.split(/\r?\n/).filter(t=>/\b(fail(?:ed|ure)?|error)\b/i.test(t))}function E(t){return t.map(t=>t.replace(/^[\d]{4}-[\d]{2}-[\d]{2} [\d]{2}:[\d]{2}:[\d]{2} /,""))}function v(){var t,e,n,r;let o;try{o=null===(t=null===require||void 0===require?void 0:require("child_process"))||void 0===t?void 0:t.spawnSync}catch(t){}if(!o&&"undefined"!=typeof globalThis)try{o=null===(r=null===(n=(e=globalThis).__cgNodeRequire)||void 0===n?void 0:n.call(e,"child_process"))||void 0===r?void 0:r.spawnSync}catch(t){}if("function"!=typeof o)throw new Error("child_process.spawnSync not available in this environment");return o}const F='<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n<array>\n',D="</array>\n</plist>";function O(t={}){const e=function(t={}){const{timestamp:e=Date.now()}=t;return Math.floor(e/1e3)}(t);return["\t\t<key>ActionUID</key>",`\t\t<integer>${e}</integer>`]}function B(t){return!0===t?["\t\t<key>StopOnFailure</key>","\t\t<true/>"]:[]}function P(t){return!1===t?["\t\t<key>NotifyOnFailure</key>","\t\t<false/>"]:[]}function L(t={}){const{notifyOnTimeout:e=!0,timeoutAborts:n=!0}=t,r=[];return(!0===n&&!1===e||!1===n&&!0===e)&&r.push("\t\t<key>NotifyOnTimeOut</key>",e?"\t\t<true/>":"\t\t<false/>"),r.push("\t\t<key>TimeOutAbortsMacro</key>",n?"\t\t<true/>":"\t\t<false/>"),r}function $(t){return t.replace(/[<>&'"]/g,t=>({"<":"&lt;",">":"&gt;","&":"&amp;","'":"&apos;",'"':"&quot;"}[t]))}function R(t){const e=t.trim().split("\n");let n=!1;return e.map(t=>{const e=t.trim();return e?e.startsWith("<string>")&&!e.endsWith("</string>")?(n=!0,"\t\t"+e):n&&"</string>"===e?(n=!1,"\t\t"+e):n?t:"<dict>"===e||"</dict>"===e?"\t"+e:"\t\t"+e:t}).join("\n")}function V(t,e){if("condition"===e){const e=["IsFrontApplication","IsFrontWindow","IsFront"];return t.sort((t,n)=>{const r=e.includes(t),o=e.includes(n);return"ConditionType"===t&&o?-1:"ConditionType"===n&&r||r&&!o?1:o&&!r?-1:t.localeCompare(n,"en")})}return t.sort((t,n)=>{if("action"===e)return"MacroActionType"===t?-1:"MacroActionType"===n?1:"ActionUID"===t?-1:"ActionUID"===n?1:t.localeCompare(n,"en");if("application"===e){const e=["BundleIdentifier","Match","Name","NewFile","Path"],r=e.indexOf(t),o=e.indexOf(n);return-1!==r&&-1!==o?r-o:-1!==r?-1:-1!==o?1:t.localeCompare(n,"en")}return t.localeCompare(n,"en")})}const j={ARandomUniqueID:"%RandomUUID%",AddressBookEmail:"%AddressBook%Email%",AddressBookFirstName:"%AddressBook%First%",AddressBookLastName:"%AddressBook%Last%",AddressBookName:"%AddressBook%Name%",AddressBookNickname:"%AddressBook%Nickname%",AddressBookNote:"%AddressBook%Note%",AddressBookOrganization:"%AddressBook%Organization%",AllAudioInputDevices:"%AudioInputDevices%",AllAudioOutputDevices:"%AudioOutputDevices%",AllBackgroundApplicationNames:"%Application%Background%",AllForegroundApplicationNames:"%Application%Foreground%",AllRunningApplicationNames:"%Application%All%",AllScreenFrames:"%Screen%All%",AllWindowNames:"%WindowName%All%",Calculation:"%Calculate%1+2%",CalculationWithResultInBinary:"%Bin8%1+2%",CalculationWithResultInDecimal:"%Dec2%1+2%",CalculationWithResultInHex:"%Hex2%1+2%",CalculationWithResultInOctal:"%Oct3%1+2%",CommaSeparatedListOfTheCurrentExecutionInstances:"%ExecutingInstances%",CommaSeparatedListOfVariablesAccessedByThisMacro:"%AccessedVariables%",CurrentAudioInputDevice:"%AudioInputDevice%",CurrentAudioInputDeviceUID:"%AudioInputDeviceUID%",CurrentAudioOutputDevice:"%AudioOutputDevice%",CurrentAudioOutputDeviceUID:"%AudioOutputDeviceUID%",CurrentAudioSoundEffectsDevice:"%AudioSoundEffectsDevice%",CurrentAudioSoundEffectsDeviceUID:"%AudioSoundEffectsDeviceUID%",CurrentMouseLocation:"%CurrentMouse%",CurrentTrackAlbum:"%CurrentTrack%album%",CurrentTrackArtist:"%CurrentTrack%artist%",CurrentTrackName:"%CurrentTrack%name%",CurrentTrackRating:"%CurrentTrack%ratingstars%",Delete:"%Delete%",ExecutingMacro:"%ExecutingMacro%",ExecutingMacroGroup:"%ExecutingMacroGroup%",ExecutingMacroGroupUUID:"%ExecutingMacroGroupUUID%",ExecutingMacroUUID:"%ExecutingMacroUUID%",ExecutingThisMacro:"%ExecutingThisMacro%",ExecutingThisMacroGroup:"%ExecutingThisMacroGroup%",ExecutingThisMacroGroupUUID:"%ExecutingThisMacroGroupUUID%",ExecutingThisMacroUUID:"%ExecutingThisMacroUUID%",FindPasteboard:"%FindPasteboard%",FinderInsertionLocationPath:"%FinderInsertionLocation%",FirstScreenFrame:"%Screen%1%",FormattedICUDateTime:"%ICUDateTime%EEE, MMM d, yyyy h:mm%",FormattedICUDateTimeFor:"%ICUDateTimeFor%NOW()+20%EEE, MMM d, yyyy h:mm%",FormattedICUDateTimeMinus:"%ICUDateTimeMinus%3*7%Days%EEE, MMM d, yyyy h:mm%",FormattedICUDateTimePlus:"%ICUDateTimePlus%3*7%Days%EEE, MMM d, yyyy h:mm%",FormattedCalculation:"%CalculateFormat%1+2%#,##0.00#%",FrontApplicationBundleID:"%ApplicationBundleID%1%",FrontApplicationLongVersion:"%ApplicationLongVersion%1%",FrontApplicationName:"%Application%1%",FrontApplicationPath:"%ApplicationPath%1%",FrontApplicationVersion:"%ApplicationVersion%1%",FrontBrowserBundleID:"%FrontBrowserBundleID%",FrontBrowserDocumentTitle:"%FrontBrowserTitle%",FrontBrowserDocumentURL:"%FrontBrowserURL%",FrontBrowserField:"%FrontBrowserField%document.forms[0][0]%",FrontBrowserJavaScript:"%FrontBrowserJavaScript%document.forms[0].innerHTML%",FrontBrowserLongVersion:"%FrontBrowserLongVersion%",FrontBrowserName:"%FrontBrowserName%",FrontBrowserPath:"%FrontBrowserPath%",FrontBrowserReadyState:"%FrontBrowserReadyState%",FrontBrowserVersion:"%FrontBrowserVersion%",FrontBrowserWindowName:"%FrontBrowserWindowName%",FrontWindowFrame:"%WindowFrame%1%",FrontWindowName:"%WindowName%1%",FrontWindowPosition:"%WindowPosition%1%",FrontWindowSize:"%WindowSize%1%",GoogleChromeBundleID:"%ChromeBundleID%",GoogleChromeDocumentTitle:"%ChromeTitle%",GoogleChromeDocumentURL:"%ChromeURL%",GoogleChromeField:"%ChromeField%document.forms[0][0]%",GoogleChromeJavaScript:"%ChromeJavaScript%document.forms[0].innerHTML%",GoogleChromeLongVersion:"%ChromeLongVersion%",GoogleChromeName:"%ChromeName%",GoogleChromePath:"%ChromePath%",GoogleChromeReadyState:"%ChromeReadyState%",GoogleChromeVersion:"%ChromeVersion%",GoogleChromeWindowName:"%ChromeWindowName%",IDOfLastKeyboardMaestroEngineWindowOpenedByThisMacro:"%LastWindowID%",IDOfTheLastAbortedAction:"%LastAbortedActionID%",JSONFromDictionary:"%JSONFromDictionary%DictionaryName%",JSONFromVariables:"%JSONFromVariables%Prefix%",JSONValue:"%JSONValue%VariableName.field(field)[1]%",KeyboardLayoutInputSource:"%KeyboardLayout%",KeyboardMaestroLongVersion:"%KeyboardMaestroLongVersion%",KeyboardMaestroVersion:"%KeyboardMaestroVersion%",Linefeed:"%LineFeed%",LongDate:"%LongDate%",MachineIPAddress:"%MacIPAddress%",MachineName:"%MacName%",MachineUniqueID:"%MacUUID%",MacroNameForUUID:"%MacroNameForUUID%UUID%",MailBCCRecipients:"%MailBCCRecipients%",MailCCRecipients:"%MailCCRecipients%",MailContents:"%MailContents%",MailRawSource:"%MailRawSource%",MailRecipients:"%MailRecipients%",MailReplyTo:"%MailReplyTo%",MailSender:"%MailSender%",MailSubject:"%MailSubject%",MailToRecipients:"%MailToRecipients%",MainScreenFrame:"%Screen%Main%",MainScreenPossibleResolutions:"%ScreenResolutions%Main%",MainScreenResolution:"%ScreenResolution%Main%",MainScreenVisibleFrame:"%ScreenVisible%Main%",MusicPlayerState:"%MusicPlayerState%",NamedClipboard:"%NamedClipboard%A Named Clipboard%",NamedClipboardFlavors:"%NamedClipboardFlavors%A Named Clipboard%",NetworkLocation:"%NetworkLocation%",NumberDate:"%NumberDate%",OpaqueIDOfTheCurrentExecutionInstance:"%ExecutingInstance%",OptionReturn:"%OptionReturn%",PastClipboard:"%PastClipboard%1%",PastClipboardFlavors:"%PastClipboardFlavors%1%",PositionCursor:"%|%",PreviousApplicationName:"%Application%2%",PromptForSnippetPlaceholderDefaultFromVariable:"%Ask20:VarName%",PromptForSnippetPlaceholderDefaultText:"%Ask20:Default%",Return:"%Return%",SafariBundleID:"%SafariBundleID%",SafariDocumentTitle:"%SafariTitle%",SafariDocumentURL:"%SafariURL%",SafariField:"%SafariField%document.forms[0][0]%",SafariJavaScript:"%SafariJavaScript%document.forms[0].innerHTML%",SafariLongVersion:"%SafariLongVersion%",SafariName:"%SafariName%",SafariPath:"%SafariPath%",SafariReadyState:"%SafariReadyState%",SafariVersion:"%SafariVersion%",SafariWindowName:"%SafariWindowName%",SecondScreenFrame:"%Screen%2%",ShortDate:"%ShortDate%",Space:"%Space%",SuccessResultOfLastAction:"%ActionResult%",SystemClipboard:"%SystemClipboard%",SystemClipboardFlavors:"%SystemClipboardFlavors%",SystemLongVersion:"%SystemLongVersion%",SystemVersion:"%SystemVersion%",SystemVolume:"%SystemVolume%",Tab:"%Tab%",TheLastAlertButtonSelected:"%AlertButton%",TheLastCustomHTMLResult:"%HTMLResult%",TheLastFoundImage:"%FoundImage%",TheLastPromptButtonSelected:"%PromptButton%",TheMacroNameOfTheSpecifiedInstance:"%ExecutingInstanceName%",TheModifiersUsedWhenCompletingAPromptWithListAction:"%PromptWithListModifiers%",ThePathOfTheFrontWindowDocument:"%FrontDocumentPath%",ThePathOfTheSelectedFinderItem:"%FinderSelection%",ThePathsOfTheSelectedFinderItems:"%FinderSelections%",TheTextEnteredInAPasteByNameAction:"%PasteByNameText%",TheTextEnteredInAPromptWithListAction:"%PromptWithListText%",TheTextEnteredInASelectMenuByNameAction:"%SelectMenuByNameText%",Time:"%ShortTime%",TimeWithSeconds:"%LongTime%",TrippedTriggerClipboardFlavors:"%TriggerClipboardFlavors%",TrippedTriggerClipboardValue:"%TriggerClipboard%",TrippedTriggerText:"%Trigger%",TrippedTriggerType:"%TriggerBase%",TrippedTriggerValue:"%TriggerValue%",UserHomeDirectory:"%UserHome%",UserLoginID:"%UserLoginID%",UserName:"%UserName%",WirelessNetworkNames:"%WirelessNetwork%"};function U(t,e){return e&&e in j?j[e]:t}function W(t){const{text:e,tokenPreset:n}=t,r=U(e,n),o=["\t<dict>",...O(),"\t\t<key>MacroActionType</key>","\t\t<string>Return</string>","\t\t<key>Text</key>",`\t\t<string>${$(null!=r?r:"")}</string>`,"\t</dict>"];return{toXml:()=>R(o.join("\n"))}}function K(t,e){const n=(e?[...t,W({text:e})]:t).map(t=>t.toXml()).join("\n");return F+n+"\n"+D}function q(t,e,n,r){if(0===t.length&&!n)return void console.log(C.yellow("No actions supplied — nothing to run."));const o=K(t,n),i=e?`virtual macro '${e}'`:"virtual macro";console.log(C.gray(`--\x3e Executing ${i} with ${t.length}${n?"+Return":""} action(s)…`)),M();const a=r?`(function () {\n        var kme = Application('Keyboard Maestro Engine');\n        var result = kme.doScript(${JSON.stringify(o)});\n        return (result !== undefined && result !== null) ? String(result) : '';\n      })();`:`Application('Keyboard Maestro Engine').doScript(${JSON.stringify(o)})`,s=v()("osascript",["-l","JavaScript","-e",a],{encoding:"utf8"});if(s.error){if(console.error(C.red("Spawn error:"),s.error),r)throw s.error}else if(s.stderr.trim()){if(console.error(C.red("[KM ERROR]"),s.stderr.trim()),r)throw new Error(`KM Error: ${s.stderr.trim()}`)}else if(0===s.status){if(function(t){const e=E(w());return e.length>0&&(console.log(),console.log(C.red.bold("[km.engineLog] Virtual macro reported engine errors:")),console.log(C.grey("----------------------------------------------------")),e.forEach(t=>{console.log(C.bgRed("  • ")+"\t"+C.redBright(t)),console.log()}),t&&(console.log(C.grey("[km.engineLog] Executed XML:")),t.split("\n").forEach(t=>console.log(C.grey("  "+t))),console.log()),!0)}(o)||(e?(console.log(C.green(`✅ ${i} executed successfully.`)),console.log(C.green(`No Keyboard Maestro engine errors detected for '${e}'.`))):(console.log(C.green("✅ Virtual macro executed successfully.")),console.log(C.green("No Keyboard Maestro engine errors detected.")))),console.log(C.magenta("[VirtualMacro XML]")),console.log(C.grey(o)),r){const t=s.stdout.trim();return console.log(C.green(`[runVirtualMacro] Result: ${t}`)),t}}else if(console.error(C.red("Non-zero exit code:",s.status)),r)throw new Error(`Non-zero exit code: ${s.status}`)}function X(t){return t?["\t\t<key>ProcessingMode</key>",`\t\t<string>${t}</string>`]:[]}function G(t){return t?["\t\t<key>Where</key>",`\t\t<string>${t}</string>`]:[]}class J extends Error{constructor(t){super(t),this.name="StyledTextError"}}function _(t){try{const e=t.replace(/\s+/g,""),n=Buffer.from(e,"base64").toString("utf8");return{rtf:n,text:Z(n)}}catch(t){const e=`[utils.styledText.decode] Failed to decode Base-64 StyledText. ${t.message}`;throw console.error(C.red(e)),new J(e)}}function H(t,e=!0){try{const n=Buffer.from(t,"utf8").toString("base64");return e?function(t,e=76){const n=[];for(let r=0;r<t.length;r+=e)n.push(t.slice(r,r+e));return n.join("\n")}(n,76):n}catch(t){const e=`[utils.styledText.encode] Failed to encode RTF into Base-64. ${t.message}`;throw console.error(C.red(e)),new J(e)}}const z=/<key>\s*StyledText\s*<\/key>\s*<data>(?<data>[\s\S]*?)<\/data>/im,Y=/<key>\s*Text\s*<\/key>\s*<string>(?<text>[\s\S]*?)<\/string>/im;function Z(t){let e=t.replace(/\\'[0-9a-fA-F]{2}/g,t=>{const e=t.slice(2);try{return Buffer.from(e,"hex").toString("latin1")}catch(t){return""}});return e=e.replace(/\{\\fonttbl[^{}]*(?:\{[^{}]*\}[^{}]*)*\}/g,""),e=e.replace(/\{\\colortbl[^{}]*(?:\{[^{}]*\}[^{}]*)*\}/g,""),e=e.replace(/\\[a-zA-Z]+\d*\s?/g," "),e=e.replace(/[{}]/g,""),e=e.replace(/\s+/g," ").trim(),e}function Q(t){return`{\\rtf1\\ansi\\deff0 ${t.replace(/\\/g,"\\\\").replace(/}/g,"\\}").replace(/{/g,"\\{")}}`}function tt(t){const{text:e,tokenPreset:n,action:r="ByTyping",processingMode:o,includeStyledText:i=!1,rtfContent:a,targetingType:s="Front"}=t,l=U(e,n);let c="",u=l;if(i&&("ByPastingStyles"===r||"DisplayWindow"===r)){let t=a;t||(t=Q(l));try{const e=H(t);c=["\t\t<key>StyledText</key>","\t\t<data>",e.split("\n").map(t=>`\t\t${t}`).join("\n"),"\t\t</data>"].join("\n"),a&&(u=Z(t))}catch(t){console.warn(`[insertText] Failed to encode styled text, falling back to plain text: ${t}`)}}const d="ByTyping"===r?["\t\t<key>TargetApplication</key>","\t\t<dict/>","\t\t<key>TargetingType</key>",`\t\t<string>${s}</string>`].join("\n"):"",p=["\t<dict>","\t\t<key>Action</key>",`\t\t<string>${r}</string>`,...O(),"\t\t<key>MacroActionType</key>","\t\t<string>InsertText</string>",...o?X(o):[],...c?[c]:[],...d?[d]:[],"\t\t<key>Text</key>",`\t\t<string>${$(u)}</string>`,"\t</dict>"];return{toXml:()=>R(p.join("\n"))}}function et(t){var e;return tt({text:U(t.text,t.tokenPreset),action:"DisplayWindow",processingMode:t.processingMode,includeStyledText:null!==(e=t.includeStyledText)&&void 0!==e&&e,rtfContent:t.rtfContent})}const nt=/^(?:INSTANCE|LOCAL)/i;function rt(t){return nt.test(t)}function ot(t){var e;const n="undefined"!=typeof process&&process.env&&null!==(e=process.env.KMINSTANCE)&&void 0!==e?e:"";let r;if(rt(t)){if(!n)throw new Error(`KMINSTANCE env var is not set – cannot access instance/local variable “${t}”.`);r=`tell application "Keyboard Maestro Engine" to getvariable "${t}" instance "${n}"`}else r=`tell application "Keyboard Maestro Engine" to getvariable "${t}"`;const{execSync:o}=require("child_process");if("function"!=typeof o)throw new Error("child_process.execSync not available in this environment");return o(`osascript -e '${r}'`,{encoding:"utf8"}).trim()}function it(t,e){var n;const r="undefined"!=typeof process&&process.env&&null!==(n=process.env.KMINSTANCE)&&void 0!==n?n:"";let o;if(rt(t)){if(!r)throw new Error(`KMINSTANCE env var is not set – cannot set instance/local variable “${t}”.`);o=`tell application "Keyboard Maestro Engine" to setvariable "${t}" to "${e}" instance "${r}"`}else o=`tell application "Keyboard Maestro Engine" to setvariable "${t}" to "${e}"`;const{execSync:i}=require("child_process");if("function"!=typeof i)throw new Error("child_process.execSync not available in this environment");i(`osascript -e '${o}'`)}const at=Object.assign(function(t,e){return void 0===e?ot(t):it(t,e)},{get:ot,set:it});function st(t={}){console.log(C.cyan("[VirtualAction] PlaySound:"),C.grey(JSON.stringify(t)));const{sound:e="Tink",path:n,asynchronously:r=!0,volume:o=75,timeoutAborts:i=!0}=t,a="string"==typeof n&&n.includes("/")?n:`/System/Library/Sounds/${e}.aiff`,s=Math.max(0,Math.min(100,Math.round(o))),l=100!==s,c=["\t<dict>",...O(),r?"\t\t<key>Asynchronously</key>":"",r?"\t\t<true/>":"","\t\t<key>DeviceID</key>","\t\t<string>SOUNDEFFECTS</string>","\t\t<key>MacroActionType</key>","\t\t<string>PlaySound</string>","\t\t<key>Path</key>",`\t\t<string>${$(a)}</string>`,"\t\t<key>TimeOutAbortsMacro</key>","\t\t<true/>",l?"\t\t<key>Volume</key>":"",l?`\t\t<integer>${s}</integer>`:"","\t</dict>"].filter(Boolean);return{toXml:()=>R(c.join("\n"))}}function lt(t){console.log(C.cyan("[VirtualAction] Notification:"),C.grey(JSON.stringify(t)));const{title:e,subtitle:n="",body:r,sound:o="",titleTokenPreset:i,subtitleTokenPreset:a,bodyTokenPreset:s}=t,l=U(e,i),c=U(n,a),u=U(r,s),d=o.includes("/"),p=["\t<dict>",...O(),"\t\t<key>MacroActionType</key>","\t\t<string>Notification</string>","\t\t<key>SoundName</key>",d?"\t\t<string></string>":`\t\t<string>${$(o)}</string>`,"\t\t<key>Subtitle</key>",`\t\t<string>${$(c)}</string>`,"\t\t<key>Text</key>",`\t\t<string>${$(u)}</string>`,"\t\t<key>Title</key>",`\t\t<string>${$(l)}</string>`,"\t</dict>"].join("\n");if(d){const t=st({path:o}),e=[p,t.toXml().trim()].join("\n");return{toXml:()=>R(e)}}return{toXml:()=>R(p)}}function ct({title:t,body:e,subtitle:n="",sound:r=""}){console.log(C.magenta("→ [kmjs.notify] Using virtual notification action"));const o=lt({title:t,body:e,subtitle:n,sound:r});console.log(C.blue("Sending virtual Keyboard Maestro notification…")),q([o],"notify"),console.log(C.green("Notification sent."))}try{if(require.main===module){const t="undefined"!=typeof process&&process.argv?process.argv.slice(2):[],[e,n,r]=t;if(e&&n)try{ct({title:e,body:n,sound:r})}catch(t){console.error("Error sending notification:",t.message),"undefined"!=typeof process&&process.exit&&process.exit(1)}else console.error("Usage: node kmjs.notify.js <title> <body> [sound]"),"undefined"!=typeof process&&process.exit&&process.exit(1)}}catch(t){}let ut=null;function dt(t){try{console.log(C.gray("[getMousePosition] Querying current mouse position..."));const e=q([],"getMousePosition",j.CurrentMouseLocation,!0);if(!e||"string"!=typeof e)throw new Error("No result returned from Keyboard Maestro");const n=e.trim();if(!n)throw new Error("Empty result returned from Keyboard Maestro");const r=n.split(",");if(2!==r.length)throw new Error(`Invalid mouse position format: expected "x,y", got "${n}"`);const[o,i]=r,a=parseInt(o.trim(),10),s=parseInt(i.trim(),10);if(isNaN(a))throw new Error(`Invalid X coordinate: "${o.trim()}" is not a valid number`);if(isNaN(s))throw new Error(`Invalid Y coordinate: "${i.trim()}" is not a valid number`);return console.log(C.green(`[getMousePosition] Successfully retrieved position: ${n} (X: ${a}, Y: ${s})`)),t?[a,s]:n}catch(t){const e=t instanceof Error?t.message:String(t);throw console.error(C.red("[getMousePosition] Error:"),e),new Error(`Failed to get mouse position: ${e}`)}}function pt(){try{const t="::KMJS_DELIMITER::",e=q([],"query:getFrontAppInfo",[j.FrontApplicationName,j.FrontApplicationBundleID,j.FrontApplicationPath].join(t),!0),[n,r,o]=e.split(t);if(!n||!r||!o)throw new Error(`Incomplete app info returned from KM: "${e}"`);return{name:n,bundleId:r,path:o}}catch(t){const e=t instanceof Error?t.message:String(t);throw new Error(`Failed to get front app info: ${e}`)}}function gt(){try{const t="::KMJS_DELIMITER::",e=q([],"query:getFrontWindowInfo",[j.FrontWindowName,j.FrontWindowFrame].join(t),!0),[n,r]=e.split(t),o=r.split(",").map(Number);if(!n||4!==o.length||o.some(isNaN))throw new Error(`Invalid window info returned from KM: "${e}"`);const[i,a,s,l]=o;return{name:n,frame:{x:i,y:a,width:s,height:l}}}catch(t){const e=t instanceof Error?t.message:String(t);throw new Error(`Failed to get front window info: ${e}`)}}function mt(){try{const t=q([],"query:getFinderSelections",j.ThePathsOfTheSelectedFinderItems,!0);return t?t.split("\n").filter(Boolean):[]}catch(t){const e=t instanceof Error?t.message:String(t);throw new Error(`Failed to get Finder selections: ${e}`)}}function yt(){try{return q([],"query:getSystemClipboard",j.SystemClipboard,!0)}catch(t){const e=t instanceof Error?t.message:String(t);throw new Error(`Failed to get system clipboard: ${e}`)}}function ht(){try{const t=q([],"query:getSystemVolume",j.SystemVolume,!0),e=parseInt(t,10);if(isNaN(e))throw new Error(`Invalid volume level returned: "${t}"`);return e}catch(t){const e=t instanceof Error?t.message:String(t);throw new Error(`Failed to get system volume: ${e}`)}}function ft(){try{const t=q([],"query:getScreenFrames",j.AllScreenFrames,!0);return t?t.split("\n").filter(Boolean).map((t,e)=>{const n=t.split(",").map(Number);if(4!==n.length||n.some(isNaN))throw new Error(`Invalid screen frame format on line ${e+1}: "${t}"`);const[r,o,i,a]=n;return{x:r,y:o,width:i,height:a}}):[]}catch(t){const e=t instanceof Error?t.message:String(t);throw new Error(`Failed to get screen frames: ${e}`)}}function kt(){try{const t=q([],"query:getRunningApps",j.AllRunningApplicationNames,!0);return t?t.split("\n").filter(Boolean):[]}catch(t){const e=t instanceof Error?t.message:String(t);throw new Error(`Failed to get running applications: ${e}`)}}function St(){try{const t="::KMJS_DELIMITER::",e=q([],"query:getNetworkInfo",[j.NetworkLocation,j.WirelessNetworkNames,j.MachineIPAddress].join(t),!0),[n,r,o]=e.split(t);if(void 0===n||void 0===r||void 0===o)throw new Error(`Incomplete network info returned from KM: "${e}"`);return{location:n,wirelessNames:r?r.split("\n").filter(Boolean):[],ipAddress:o}}catch(t){const e=t instanceof Error?t.message:String(t);throw new Error(`Failed to get network info: ${e}`)}}function Tt(){try{const t="::KMJS_DELIMITER::",e=q([],"query:getUserInfo",[j.UserName,j.UserLoginID,j.UserHomeDirectory].join(t),!0),[n,r,o]=e.split(t);if(!n||!r||!o)throw new Error(`Incomplete user info returned from KM: "${e}"`);return{name:n,loginId:r,home:o}}catch(t){const e=t instanceof Error?t.message:String(t);throw new Error(`Failed to get user info: ${e}`)}}function bt(){try{const t="::KMJS_DELIMITER::",e=q([],"query:getSystemVersion",[j.SystemVersion,j.SystemLongVersion].join(t),!0),[n,r]=e.split(t);if(!n||!r)throw new Error(`Incomplete system version returned from KM: "${e}"`);return{short:n,long:r}}catch(t){const e=t instanceof Error?t.message:String(t);throw new Error(`Failed to get system version: ${e}`)}}function Nt(t){if(!Number.isInteger(t)||t<0)throw new Error(`Clipboard history index must be a non-negative integer, but received: ${t}`);try{const e=`%PastClipboard%${t}%`;return q([],`query:getPastClipboard:${t}`,e,!0)}catch(e){const n=e instanceof Error?e.message:String(e);throw new Error(`Failed to get past clipboard at index ${t}: ${n}`)}}function xt(t="Main"){const e=q([],"query:getScreenResolution",`%ScreenResolution%${t}%`,!0),n=t=>{const e=t.split(",").map(Number);if(5!==e.length||e.some(isNaN))throw new Error(`Invalid ScreenResolution format: “${t}”`);const[n,r,o,i,a]=e;return{nominalWidth:n,nominalHeight:r,pixelWidth:o,pixelHeight:i,refreshRate:a}};return"all"===t.toLowerCase()?e.split(/\n|\r|\r\n/).filter(Boolean).map(n):n(e)}require.main===module&&require("./kmjs.query.cli"),require.main===module&&require("./kmjs.query.cli"),require.main===module&&require("./kmjs.query.cli"),require.main===module&&require("./kmjs.query.cli"),require.main===module&&require("./kmjs.query.cli"),require.main===module&&require("./kmjs.query.cli"),require.main===module&&require("./kmjs.query.cli"),require.main===module&&require("./kmjs.query.cli"),require.main===module&&require("./kmjs.query.cli"),require.main===module&&require("./kmjs.query.cli"),require.main===module&&require("./kmjs.query.cli"),require.main===module&&require("./kmjs.query.cli"),require.main===module&&require("./kmjs.query.cli");const Ct={getMousePosition:dt,getFrontAppInfo:pt,getFrontWindowInfo:gt,getFinderSelections:mt,getSystemClipboard:yt,getSystemVolume:ht,getScreenFrames:ft,getRunningApps:kt,getNetworkInfo:St,getUserInfo:Tt,getSystemVersion:bt,getPastClipboard:Nt,getScreenResolution:xt},At={...Ct},It={...Ct};function Mt(t){const{cancelType:e,instance:n}=t;if("CancelSpecificMacro"===e&&!n)throw new Error("CancelSpecificMacro requires an 'instance' (macro name or UUID) to cancel.");const r=["\t<dict>","\t\t<key>Action</key>",`\t\t<string>${e}</string>`,...O(),..."CancelSpecificMacro"===e?["\t\t<key>Instance</key>",`\t\t<string>${$(null!=n?n:"")}</string>`]:[],"\t\t<key>MacroActionType</key>","\t\t<string>Cancel</string>","\t</dict>"];return{toXml:()=>R(r.join("\n"))}}function wt(t,e){switch(e.type){case"ScreenIndex":return[`<key>${t}</key>`,"<dict>","\t<key>IndexExpression</key>",`\t<string>${e.index}</string>`,"\t<key>ScreenAreaType</key>","\t<string>ScreenIndex</string>","</dict>"].join("\n");case"WindowIndex":return[`<key>${t}</key>`,"<dict>","\t<key>IndexExpression</key>",`\t<string>${e.index}</string>`,"\t<key>ScreenAreaType</key>","\t<string>WindowIndex</string>","</dict>"].join("\n");case"Area":return[`<key>${t}</key>`,"<dict>","\t<key>HeightExpression</key>",`\t<string>${e.height}</string>`,"\t<key>LeftExpression</key>",`\t<string>${e.left}</string>`,"\t<key>ScreenAreaType</key>","\t<string>Area</string>","\t<key>TopExpression</key>",`\t<string>${e.top}</string>`,"\t<key>WidthExpression</key>",`\t<string>${e.width}</string>`,"</dict>"].join("\n");case"WindowName":case"WindowNameContaining":case"WindowNameMatching":return[`<key>${t}</key>`,"<dict>","\t<key>ScreenAreaType</key>",`\t<string>${e.type}</string>`,"\t<key>WindowName</key>",`\t<string>${e.name}</string>`,"</dict>"].join("\n");default:return[`<key>${t}</key>`,"<dict>","\t<key>ScreenAreaType</key>",`\t<string>${e.type}</string>`,"</dict>"].join("\n")}}function Et(t){var e;return null!==(e=Ft[t])&&void 0!==e?e:t}function vt(t){return Ot[t]}const Ft={Cmd:"Cmd",Command:"Cmd",Meta:"Cmd",CmdLeft:"Cmd",CmdRight:"Cmd",CommandLeft:"Cmd",CommandRight:"Cmd",MetaLeft:"Cmd",MetaRight:"Cmd",Win:"Cmd",WinLeft:"Cmd",WinRight:"Cmd",Windows:"Cmd",WindowsLeft:"Cmd",WindowsRight:"Cmd",Shift:"Shift",ShiftLeft:"Shift",ShiftRight:"Shift",Option:"Option",OptionLeft:"Option",OptionRight:"Option",Opt:"Option",OptLeft:"Option",OptRight:"Option",Alt:"Option",AltLeft:"Option",AltRight:"Option",Ctrl:"Control",CtrlLeft:"Control",CtrlRight:"Control",Control:"Control",ControlLeft:"Control",ControlRight:"Control",macControl:"Control"},Dt={Cmd:256,Shift:512,Option:2048,Control:4096},Ot={Backquote:50,Digit1:18,Digit2:19,Digit3:20,Digit4:21,Digit5:23,Digit6:22,Digit7:26,Digit8:28,Digit9:25,Digit0:29,Minus:27,Equal:24,KeyQ:12,KeyW:13,KeyE:14,KeyR:15,KeyT:17,KeyY:16,KeyU:32,KeyI:34,KeyO:31,KeyP:35,BracketLeft:33,BracketRight:30,Backslash:42,KeyA:0,KeyS:1,KeyD:2,KeyF:3,KeyG:5,KeyH:4,KeyJ:38,KeyK:40,KeyL:37,Semicolon:41,Quote:39,KeyZ:6,KeyX:7,KeyC:8,KeyV:9,KeyB:11,KeyN:45,KeyM:46,Comma:43,Period:47,Slash:44,Space:49,Tab:48,Enter:36,NumpadEnter:76,Backspace:51,Delete:51,Escape:53,CapsLock:57,ArrowLeft:123,ArrowRight:124,ArrowDown:125,ArrowUp:126,Home:115,End:119,PageUp:116,PageDown:121,F1:122,F2:120,F3:99,F4:118,F5:96,F6:97,F7:98,F8:100,F9:101,F10:109,F11:103,F12:111,F13:105,F14:107,F15:113,F16:106,F17:64,F18:79,F19:80,F20:90,Numpad0:82,Numpad1:83,Numpad2:84,Numpad3:85,Numpad4:86,Numpad5:87,Numpad6:88,Numpad7:89,Numpad8:91,Numpad9:92,NumpadMultiply:67,NumpadAdd:69,NumpadSubtract:78,NumpadDivide:75,NumpadDecimal:65,NumpadEqual:81,NumLock:71,Insert:114,PrintScreen:114,Pause:131};function Bt(t){return t in Ft}function Pt(t){const e=["Cmd","Option","Shift","Control"];return[...t].sort((t,n)=>e.indexOf(t)-e.indexOf(n))}function Lt(t){return t.reduce((t,e)=>t+Dt[e],0)}function $t(t){const e=t.split("+").map(t=>t.trim()).filter(Boolean),n=[];let r="";for(const t of e)Bt(t)?n.push(Et(t)):r=t;return{modifiers:Pt(n),keyToken:r}}function Rt(t){const{modifier:e,key:n}=function(t){const{modifiers:e,keyToken:n}=$t(t),r=Lt(e);let o=n,i=!1;const a=/^KeyCode:(\d+)$/.exec(o);a&&(i=!0,o=a[1]);let s=i?void 0:vt(o);if(!i&&void 0===s&&1===o.length){const t=o.toUpperCase(),e=/[A-Z]/.test(t)?`Key${t}`:/[0-9]/.test(t)?`Digit${t}`:void 0;e&&(s=vt(e))}if(void 0===s&&/^\d+$/.test(o)&&(i||o.length>1)){const t=Number(o);t>=0&&t<=255&&(s=t)}if(void 0===s)throw new Error(`Unsupported key token: "${n}"`);return{modifier:r,key:s}}(t);return{[e]:n}}function Vt(t){if("number"==typeof t&&Number.isInteger(t)){if(t<0||t>255)throw new Error(`Key code out of range: ${t}`);return{0:t}}if("object"==typeof t&&null!==t&&1===Object.keys(t).length&&Object.entries(t).every(([t,e])=>!isNaN(Number(t))&&("number"==typeof e||null===e)))return t;if("string"==typeof t){const e=$t(t);if(""===e.keyToken&&e.modifiers.length>0){const t=Lt(e.modifiers);return{[t]:null}}}return Rt(String(t))}const jt={Left:0,Right:1,Center:2,Button4:3,Button5:4,Button6:5},Ut={Click:1,DoubleClick:2,TripleClick:3};function Wt(t={}){var e;const{clickKind:n="Click",button:r="Left",clickModifiers:o=0,horizontal:i=0,vertical:a=0,relative:s="Image",relativeCorner:l,imageSource:c="Image",fuzz:u,waitForImage:d=!0,imageSelection:p="Unique",namedClipboardUUID:g,filePath:m,screenArea:y={type:"ScreenAll"},imageScreenArea:h,mouseDrag:f="None",dragTargetX:k=0,dragTargetY:S=0,restoreMouseLocation:T=!1}=t,b="Release"!==n&&T,N=void 0!==l?l:"Mouse"===s||"Absolute"===s?"TopLeft":"Center",x="NamedClipboard"===c?null!=g?g:"FE1390C3-74DF-4983-9C6B-E2C441F97963":void 0;if("File"===c&&!m)throw new Error("filePath must be supplied when imageSource === 'File'");const C=(()=>{if("number"==typeof o)return o;const t=Vt(o);return Number(Object.keys(t)[0])})();let A,I;switch(n){case"Move":A="Move",I=0;break;case"Release":A="MoveAndClick",I=-1;break;default:I=Ut[n],A=b?"Click":"MoveAndClick"}let M=f;"Click"!==n&&"DoubleClick"!==n||"From"!==f&&"Drag"!==f&&"Release"!==f||(M="None");const w="number"==typeof u?Math.max(0,Math.min(100,Math.round(u))):15,E="Image"===s,v=E&&"File"===c?["\t\t<key>ImagePath</key>",`\t\t<string>${m}</string>`]:[],F=E&&"NamedClipboard"===c?["\t\t<key>ImageNamedClipboardName</key>",`\t\t<string>${x}</string>`,"\t\t<key>ImageNamedClipboardRedundandDisplayName</key>","\t\t<string>Unnamed Named Clipboard</string>"]:[],D=E&&"Screen"===c?wt("ImageScreenArea",null!==(e=null!=h?h:y)&&void 0!==e?e:{type:"ScreenAll"}).split("\n").map(t=>t?`\t\t${t}`:t):[],B="Unique"!==p&&"Image"===s?["\t\t<key>ImageSelection</key>",`\t\t<string>${p}</string>`]:[],P=N?["\t\t<key>RelativeCorner</key>",`\t\t<string>${N}</string>`]:[],L="Image"===s?wt("ScreenArea",y).split("\n").map(t=>t?`\t\t${t}`:t):[],$=E&&"Image"!==c?["\t\t<key>ImageSource</key>",`\t\t<string>${c}</string>`]:[];let V=[];!0===t.waitForImage&&(V=["\t\t<key>TimeOutAbortsMacro</key>","\t\t<true/>","\t\t<key>WaitForImage</key>","\t\t<true/>"]);const j=["\t<dict>","\t\t<key>Action</key>",`\t\t<string>${A}</string>`,...O(),"\t\t<key>Button</key>",`\t\t<integer>${jt[r]}</integer>`,"\t\t<key>ClickCount</key>",`\t\t<integer>${I}</integer>`,"\t\t<key>DisplayMatches</key>","\t\t<false/>","\t\t<key>DragHorizontalPosition</key>",`\t\t<string>${k}</string>`,"\t\t<key>DragVerticalPosition</key>",`\t\t<string>${S}</string>`,"\t\t<key>Fuzz</key>",`\t\t<integer>${w}</integer>`,"\t\t<key>HorizontalPositionExpression</key>",`\t\t<string>${i}</string>`,...v,...F,...D,...B,...$,"\t\t<key>MacroActionType</key>","\t\t<string>MouseMoveAndClick</string>","\t\t<key>Modifiers</key>",`\t\t<integer>${C}</integer>`,"\t\t<key>MouseDrag</key>",`\t\t<string>${M}</string>`,"\t\t<key>Relative</key>",`\t\t<string>${s}</string>`,...P,"\t\t<key>RestoreMouseLocation</key>",`\t\t<${b?"true":"false"}/>`,...L,"\t\t<key>VerticalPositionExpression</key>",`\t\t<string>${a}</string>`,...V,"\t</dict>"];return{toXml:()=>R(j.join("\n"))}}const Kt=new Set(["TitleIs","TitleIsNot","TitleContains","TitleDoesNotContain","TitleMatches","TitleDoesNotMatch"]),qt=new Set(["ExistsButTitleIsNot","ExistsButTitleDoesNotContain","ExistsButTitleDoesNotMatch"]);function Xt(t){return wt("ImageScreenArea",t).split("\n").filter(Boolean).map(t=>"\t"+t)}function Gt(t){var e;"ScreenImage"===t.ConditionType&&("ScreenImage"!==(e=t).ConditionType||(e.ScreenArea&&"object"==typeof e.ScreenArea&&e.ScreenArea.type||(e.ScreenArea={type:"ScreenAll"}),"Screen"!==e.ImageSource||e.ImageScreenArea||(e.ImageScreenArea=e.ScreenArea),delete e.ImageSelection,"Image"!==e.ImageSource&&e.ImageSource?"File"===e.ImageSource?(delete e.ImageNamedClipboardName,delete e.ImageNamedClipboardRedundandDisplayName):"NamedClipboard"===e.ImageSource?delete e.ImagePath:("SystemClipboard"===e.ImageSource||"TriggerClipboard"===e.ImageSource||"Icon"===e.ImageSource||"Screen"===e.ImageSource)&&(delete e.ImagePath,delete e.ImageNamedClipboardName,delete e.ImageNamedClipboardRedundandDisplayName):(delete e.ImagePath,delete e.ImageNamedClipboardName,delete e.ImageNamedClipboardRedundandDisplayName,delete e.ImageSource),void 0===e.DisplayMatches&&(e.DisplayMatches=!1),void 0===e.Fuzz&&(e.Fuzz=0)),t=e),"OCR"===t.ConditionType&&(t=function(t){if("OCR"!==t.ConditionType)return t;const e=t.ImageSource;return"File"===e?(delete t.ImageNamedClipboardName,delete t.ImageNamedClipboardRedundandDisplayName,delete t.ImageScreenArea):"NamedClipboard"===e?(delete t.ImagePath,delete t.ImageScreenArea):"Screen"===e?(delete t.ImagePath,delete t.ImageNamedClipboardName,delete t.ImageNamedClipboardRedundandDisplayName):"SystemClipboard"!==e&&"TriggerClipboard"!==e&&"Icon"!==e&&"Image"!==e||(delete t.ImagePath,delete t.ImageNamedClipboardName,delete t.ImageNamedClipboardRedundandDisplayName,delete t.ImageScreenArea,"Image"===e&&delete t.ImageSource),Object.keys(t).forEach(e=>{void 0===t[e]&&delete t[e]}),t}(t)),"FrontWindow"!==t.ConditionType&&"AnyWindow"!==t.ConditionType||(t=function(t){if("FrontWindow"!==t.ConditionType&&"AnyWindow"!==t.ConditionType)return t;const e={...t};if(void 0===e.IsFrontApplication&&(e.IsFrontApplication=!0),e.IsFrontApplication?delete e.Application:e.Application&&0!==Object.keys(e.Application).length||(e.Application={}),"FrontWindow"===e.ConditionType){const t=e.FrontWindowConditionType;Kt.has(t)?void 0===e.FrontWindowTitle&&(e.FrontWindowTitle="Untitled"):qt.has(t)?void 0===e.FrontWindowTitle&&(e.FrontWindowTitle=""):delete e.FrontWindowTitle}return"AnyWindow"===e.ConditionType&&void 0===e.AnyWindowTitle&&(e.AnyWindowTitle=""),e}(t)),"Pixel"===t.ConditionType&&(t=function(t){if("Pixel"!==t.ConditionType)return{...t};const e={Is:"IsNot",IsNot:"IsBrighter",IsBrighter:"IsDarker",IsDarker:"IsMoreRed",IsMoreRed:"IsLessRed",IsLessRed:"IsMoreGreen",IsMoreGreen:"IsLessGreen",IsLessGreen:"IsMoreBlue",IsMoreBlue:"IsLessBlueIsNot",IsLessBlue:"IsLessBlue"},n=new Set(Object.values(e)),r=new Set(Object.keys(e));let{PixelConditionType:o,PixelConditionTypeGood:i,...a}=t;return n.has(o)||(o="IsNot"),r.has(i)||(i="Is"),e[i]!==o&&(o=e[i]),{...a,ConditionType:"Pixel",PixelConditionType:o,PixelConditionTypeGood:i}}(t)),"Script"===t.ConditionType&&(t=function(t){if("Script"!==t.ConditionType)return t;const e={...t};return Array.isArray(e.IncludedVariables)||(!0===e.includeAllVariables?e.IncludedVariables=["9999"]:e.IncludedVariables=[]),delete e.includeAllVariables,e}(t));const n=["<dict>"],r=V(Object.keys(t),"condition");for(const e of r){const r=t[e];if(null!=r)if("OCR"===t.ConditionType&&"ImageScreenArea"===e&&"object"==typeof r&&"type"in r)Xt(r).forEach(t=>n.push(t));else{if("ScreenImage"===t.ConditionType&&("ScreenArea"===e||"ImageScreenArea"===e)&&"object"==typeof r&&"type"in r){wt(e,r).split("\n").filter(Boolean).forEach(t=>n.push("\t"+t));continue}if("MouseButton"!==t.ConditionType||"Pressed"!==e){if(n.push(`\t<key>${e}</key>`),"string"==typeof r)n.push(""===r?"\t<string/>":`\t<string>${r}</string>`);else if("number"==typeof r)n.push(`\t<integer>${r}</integer>`);else if("boolean"==typeof r)n.push("\t"+(r?"<true/>":"<false/>"));else if(Array.isArray(r))n.push("\t<array>"),r.forEach(t=>n.push(`\t\t<string>${t}</string>`)),n.push("\t</array>");else if("object"==typeof r){n.push("\t<dict>");const t=V(Object.keys(r),"Application"===e?"application":void 0);for(const e of t){const t=r[e];null!=t&&(n.push(`\t\t<key>${e}</key>`),n.push("string"==typeof t&&""===t?"\t\t<string/>":`\t\t<string>${t}</string>`))}n.push("\t</dict>")}}else!1===r&&(n.push("\t<key>Pressed</key>"),n.push("\t<false/>"))}}return n.push("</dict>"),n.join("\n")}function Jt(t="Front",e={}){if("Specific"===t){const{name:t,bundleIdentifier:n,path:r,match:o,newFile:i}=e,a={};n&&(a.BundleIdentifier=n),o&&(a.Match=o),t&&(a.Name=t),i&&(a.NewFile=i),r&&(a.Path=r);return["<dict>",...V(Object.keys(a),"application").flatMap(t=>[`<key>${t}</key>`,`<string>${$(a[t])}</string>`]),"</dict>"]}return["<dict/>"]}function _t(t={}){console.log(C.cyan("[VirtualAction] Pause:"),C.grey(JSON.stringify(t)));const e=Object.prototype.hasOwnProperty.call(t,"time"),{time:n=.05,unit:r}=t;if(!e&&void 0!==r)throw new Error("Cannot specify 'unit' without 'time'.");const o=["\t<dict>",...O(),"\t\t<key>MacroActionType</key>","\t\t<string>Pause</string>","\t\t<key>Time</key>",`\t\t<string>${n}</string>`,"\t\t<key>TimeOutAbortsMacro</key>","\t\t<true/>",r&&"Seconds"!==r?"\t\t<key>Unit</key>":"",r&&"Seconds"!==r?`\t\t<string>${r}</string>`:"","\t</dict>"].filter(Boolean);return{toXml:()=>R(o.join("\n"))}}function Ht(t,e){const n=[];return n.push("\t\t<key>Text</key>"),n.push(""===t?"\t\t<string/>":`\t\t<string>${t}</string>`),e&&(n.push("\t\t<key>TextProcessingMode</key>"),n.push(`\t\t<string>${e}</string>`)),n}function zt(t){return"TriggerClipboard"===t?["\t\t<key>DestinationUseTriggerClipboard</key>","\t\t<true/>"]:(e=t)&&"object"==typeof e&&"name"in e?["\t\t<key>DestinationNamedClipboardRedundantDisplayName</key>",`\t\t<string>${t.name}</string>`,...t.uid?["\t\t<key>DestinationNamedClipboardUID</key>",`\t\t<string>${t.uid}</string>`]:[],"\t\t<key>DestinationUseNamedClipboard</key>","\t\t<true/>"]:[];var e}const Yt={PressButtonNamed:void 0,ShowMenuOfButtonNamed:"AXShowMenu",DecrementSliderNamed:"AXDecrement",IncrementSliderNamed:"AXIncrement",CancelButtonNamed:"AXCancel"};var Zt,Qt,te={},ee={};function ne(){return Zt||(Zt=1,function(t){const e=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",n="["+e+"]["+(e+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*",r=new RegExp("^"+n+"$");t.isExist=function(t){return void 0!==t},t.isEmptyObject=function(t){return 0===Object.keys(t).length},t.merge=function(t,e,n){if(e){const r=Object.keys(e),o=r.length;for(let i=0;i<o;i++)t[r[i]]="strict"===n?[e[r[i]]]:e[r[i]]}},t.getValue=function(e){return t.isExist(e)?e:""},t.isName=function(t){const e=r.exec(t);return!(null==e)},t.getAllMatches=function(t,e){const n=[];let r=e.exec(t);for(;r;){const o=[];o.startIndex=e.lastIndex-r[0].length;const i=r.length;for(let t=0;t<i;t++)o.push(r[t]);n.push(o),r=e.exec(t)}return n},t.nameRegexp=n}(ee)),ee}function re(){if(Qt)return te;Qt=1;const t=ne(),e={allowBooleanAttributes:!1,unpairedTags:[]};function n(t){return" "===t||"\t"===t||"\n"===t||"\r"===t}function r(t,e){const n=e;for(;e<t.length;e++)if("?"==t[e]||" "==t[e]){const r=t.substr(n,e-n);if(e>5&&"xml"===r)return d("InvalidXml","XML declaration allowed only at the start of the document.",m(t,e));if("?"==t[e]&&">"==t[e+1]){e++;break}continue}return e}function o(t,e){if(t.length>e+5&&"-"===t[e+1]&&"-"===t[e+2]){for(e+=3;e<t.length;e++)if("-"===t[e]&&"-"===t[e+1]&&">"===t[e+2]){e+=2;break}}else if(t.length>e+8&&"D"===t[e+1]&&"O"===t[e+2]&&"C"===t[e+3]&&"T"===t[e+4]&&"Y"===t[e+5]&&"P"===t[e+6]&&"E"===t[e+7]){let n=1;for(e+=8;e<t.length;e++)if("<"===t[e])n++;else if(">"===t[e]&&(n--,0===n))break}else if(t.length>e+9&&"["===t[e+1]&&"C"===t[e+2]&&"D"===t[e+3]&&"A"===t[e+4]&&"T"===t[e+5]&&"A"===t[e+6]&&"["===t[e+7])for(e+=8;e<t.length;e++)if("]"===t[e]&&"]"===t[e+1]&&">"===t[e+2]){e+=2;break}return e}te.validate=function(t,i){i=Object.assign({},e,i);const a=[];let l=!1,p=!1;"\ufeff"===t[0]&&(t=t.substr(1));for(let e=0;e<t.length;e++)if("<"===t[e]&&"?"===t[e+1]){if(e+=2,e=r(t,e),e.err)return e}else{if("<"!==t[e]){if(n(t[e]))continue;return d("InvalidChar","char '"+t[e]+"' is not expected.",m(t,e))}{let y=e;if(e++,"!"===t[e]){e=o(t,e);continue}{let h=!1;"/"===t[e]&&(h=!0,e++);let f="";for(;e<t.length&&">"!==t[e]&&" "!==t[e]&&"\t"!==t[e]&&"\n"!==t[e]&&"\r"!==t[e];e++)f+=t[e];if(f=f.trim(),"/"===f[f.length-1]&&(f=f.substring(0,f.length-1),e--),!g(f)){let n;return n=0===f.trim().length?"Invalid space after '<'.":"Tag '"+f+"' is an invalid name.",d("InvalidTag",n,m(t,e))}const k=s(t,e);if(!1===k)return d("InvalidAttr","Attributes for '"+f+"' have open quote.",m(t,e));let S=k.value;if(e=k.index,"/"===S[S.length-1]){const n=e-S.length;S=S.substring(0,S.length-1);const r=c(S,i);if(!0!==r)return d(r.err.code,r.err.msg,m(t,n+r.err.line));l=!0}else if(h){if(!k.tagClosed)return d("InvalidTag","Closing tag '"+f+"' doesn't have proper closing.",m(t,e));if(S.trim().length>0)return d("InvalidTag","Closing tag '"+f+"' can't have attributes or invalid starting.",m(t,y));if(0===a.length)return d("InvalidTag","Closing tag '"+f+"' has not been opened.",m(t,y));{const e=a.pop();if(f!==e.tagName){let n=m(t,e.tagStartPos);return d("InvalidTag","Expected closing tag '"+e.tagName+"' (opened in line "+n.line+", col "+n.col+") instead of closing tag '"+f+"'.",m(t,y))}0==a.length&&(p=!0)}}else{const n=c(S,i);if(!0!==n)return d(n.err.code,n.err.msg,m(t,e-S.length+n.err.line));if(!0===p)return d("InvalidXml","Multiple possible root nodes found.",m(t,e));-1!==i.unpairedTags.indexOf(f)||a.push({tagName:f,tagStartPos:y}),l=!0}for(e++;e<t.length;e++)if("<"===t[e]){if("!"===t[e+1]){e++,e=o(t,e);continue}if("?"!==t[e+1])break;if(e=r(t,++e),e.err)return e}else if("&"===t[e]){const n=u(t,e);if(-1==n)return d("InvalidChar","char '&' is not expected.",m(t,e));e=n}else if(!0===p&&!n(t[e]))return d("InvalidXml","Extra text at the end",m(t,e));"<"===t[e]&&e--}}}return l?1==a.length?d("InvalidTag","Unclosed tag '"+a[0].tagName+"'.",m(t,a[0].tagStartPos)):!(a.length>0)||d("InvalidXml","Invalid '"+JSON.stringify(a.map(t=>t.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):d("InvalidXml","Start tag expected.",1)};const i='"',a="'";function s(t,e){let n="",r="",o=!1;for(;e<t.length;e++){if(t[e]===i||t[e]===a)""===r?r=t[e]:r!==t[e]||(r="");else if(">"===t[e]&&""===r){o=!0;break}n+=t[e]}return""===r&&{value:n,index:e,tagClosed:o}}const l=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function c(e,n){const r=t.getAllMatches(e,l),o={};for(let t=0;t<r.length;t++){if(0===r[t][1].length)return d("InvalidAttr","Attribute '"+r[t][2]+"' has no space in starting.",y(r[t]));if(void 0!==r[t][3]&&void 0===r[t][4])return d("InvalidAttr","Attribute '"+r[t][2]+"' is without value.",y(r[t]));if(void 0===r[t][3]&&!n.allowBooleanAttributes)return d("InvalidAttr","boolean attribute '"+r[t][2]+"' is not allowed.",y(r[t]));const e=r[t][2];if(!p(e))return d("InvalidAttr","Attribute '"+e+"' is an invalid name.",y(r[t]));if(o.hasOwnProperty(e))return d("InvalidAttr","Attribute '"+e+"' is repeated.",y(r[t]));o[e]=1}return!0}function u(t,e){if(";"===t[++e])return-1;if("#"===t[e])return function(t,e){let n=/\d/;for("x"===t[e]&&(e++,n=/[\da-fA-F]/);e<t.length;e++){if(";"===t[e])return e;if(!t[e].match(n))break}return-1}(t,++e);let n=0;for(;e<t.length;e++,n++)if(!(t[e].match(/\w/)&&n<20)){if(";"===t[e])break;return-1}return e}function d(t,e,n){return{err:{code:t,msg:e,line:n.line||n,col:n.col}}}function p(e){return t.isName(e)}function g(e){return t.isName(e)}function m(t,e){const n=t.substring(0,e).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function y(t){return t.startIndex+t[1].length}return te}var oe,ie,ae,se,le,ce,ue,de,pe,ge,me,ye={};function he(){if(ae)return ie;ae=1;return ie=class{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,e){"__proto__"===t&&(t="#__proto__"),this.child.push({[t]:e})}addChild(t){"__proto__"===t.tagname&&(t.tagname="#__proto__"),t[":@"]&&Object.keys(t[":@"]).length>0?this.child.push({[t.tagname]:t.child,":@":t[":@"]}):this.child.push({[t.tagname]:t.child})}}}function fe(){if(ue)return ce;ue=1;const t=/^[-+]?0x[a-fA-F0-9]+$/,e=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,n={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};return ce=function(r,o={}){if(o=Object.assign({},n,o),!r||"string"!=typeof r)return r;let i=r.trim();if(void 0!==o.skipLike&&o.skipLike.test(i))return r;if("0"===r)return 0;if(o.hex&&t.test(i))return function(t,e){if(parseInt)return parseInt(t,e);if(Number.parseInt)return Number.parseInt(t,e);if(window&&window.parseInt)return window.parseInt(t,e);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(i,16);if(-1!==i.search(/[eE]/)){const t=i.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(t){if(o.leadingZeros)i=(t[1]||"")+t[3];else if("0"!==t[2]||"."!==t[3][0])return r;return o.eNotation?Number(i):r}return r}{const t=e.exec(i);if(t){const e=t[1],n=t[2];let a=function(t){if(t&&-1!==t.indexOf("."))return"."===(t=t.replace(/0+$/,""))?t="0":"."===t[0]?t="0"+t:"."===t[t.length-1]&&(t=t.substr(0,t.length-1)),t;return t}(t[3]);if(!o.leadingZeros&&n.length>0&&e&&"."!==i[2])return r;if(!o.leadingZeros&&n.length>0&&!e&&"."!==i[1])return r;if(o.leadingZeros&&n===r)return 0;{const t=Number(i),s=""+t;return-1!==s.search(/[eE]/)?o.eNotation?t:r:-1!==i.indexOf(".")?"0"===s&&""===a||s===a||e&&s==="-"+a?t:r:n?a===s||e+a===s?t:r:i===s||i===e+s?t:r}}return r}}}function ke(){if(pe)return de;return pe=1,de=function(t){return"function"==typeof t?t:Array.isArray(t)?e=>{for(const n of t){if("string"==typeof n&&e===n)return!0;if(n instanceof RegExp&&n.test(e))return!0}}:()=>!1}}function Se(){if(me)return ge;me=1;const t=ne(),e=he(),n=function(){if(le)return se;le=1;const t=ne();function e(t,e){let n="";for(;e<t.length&&"'"!==t[e]&&'"'!==t[e];e++)n+=t[e];if(n=n.trim(),-1!==n.indexOf(" "))throw new Error("External entites are not supported");const r=t[e++];let o="";for(;e<t.length&&t[e]!==r;e++)o+=t[e];return[n,o,e]}function n(t,e){return"!"===t[e+1]&&"-"===t[e+2]&&"-"===t[e+3]}function r(t,e){return"!"===t[e+1]&&"E"===t[e+2]&&"N"===t[e+3]&&"T"===t[e+4]&&"I"===t[e+5]&&"T"===t[e+6]&&"Y"===t[e+7]}function o(t,e){return"!"===t[e+1]&&"E"===t[e+2]&&"L"===t[e+3]&&"E"===t[e+4]&&"M"===t[e+5]&&"E"===t[e+6]&&"N"===t[e+7]&&"T"===t[e+8]}function i(t,e){return"!"===t[e+1]&&"A"===t[e+2]&&"T"===t[e+3]&&"T"===t[e+4]&&"L"===t[e+5]&&"I"===t[e+6]&&"S"===t[e+7]&&"T"===t[e+8]}function a(t,e){return"!"===t[e+1]&&"N"===t[e+2]&&"O"===t[e+3]&&"T"===t[e+4]&&"A"===t[e+5]&&"T"===t[e+6]&&"I"===t[e+7]&&"O"===t[e+8]&&"N"===t[e+9]}function s(e){if(t.isName(e))return e;throw new Error(`Invalid entity name ${e}`)}return se=function(t,l){const c={};if("O"!==t[l+3]||"C"!==t[l+4]||"T"!==t[l+5]||"Y"!==t[l+6]||"P"!==t[l+7]||"E"!==t[l+8])throw new Error("Invalid Tag instead of DOCTYPE");{l+=9;let u=1,d=!1,p=!1,g="";for(;l<t.length;l++)if("<"!==t[l]||p)if(">"===t[l]){if(p?"-"===t[l-1]&&"-"===t[l-2]&&(p=!1,u--):u--,0===u)break}else"["===t[l]?d=!0:g+=t[l];else{if(d&&r(t,l)){let n,r;l+=7,[n,r,l]=e(t,l+1),-1===r.indexOf("&")&&(c[s(n)]={regx:RegExp(`&${n};`,"g"),val:r})}else if(d&&o(t,l))l+=8;else if(d&&i(t,l))l+=8;else if(d&&a(t,l))l+=9;else{if(!n)throw new Error("Invalid DOCTYPE");p=!0}u++,g=""}if(0!==u)throw new Error("Unclosed DOCTYPE")}return{entities:c,i:l}}}(),r=fe(),o=ke();function i(t){const e=Object.keys(t);for(let n=0;n<e.length;n++){const r=e[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:t[r]}}}function a(t,e,n,r,o,i,a){if(void 0!==t&&(this.options.trimValues&&!r&&(t=t.trim()),t.length>0)){a||(t=this.replaceEntitiesValue(t));const r=this.options.tagValueProcessor(e,t,n,o,i);if(null==r)return t;if(typeof r!=typeof t||r!==t)return r;if(this.options.trimValues)return k(t,this.options.parseTagValue,this.options.numberParseOptions);return t.trim()===t?k(t,this.options.parseTagValue,this.options.numberParseOptions):t}}function s(t){if(this.options.removeNSPrefix){const e=t.split(":"),n="/"===t.charAt(0)?"/":"";if("xmlns"===e[0])return"";2===e.length&&(t=n+e[1])}return t}const l=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function c(e,n,r){if(!0!==this.options.ignoreAttributes&&"string"==typeof e){const r=t.getAllMatches(e,l),o=r.length,i={};for(let t=0;t<o;t++){const e=this.resolveNameSpace(r[t][1]);if(this.ignoreAttributesFn(e,n))continue;let o=r[t][4],a=this.options.attributeNamePrefix+e;if(e.length)if(this.options.transformAttributeName&&(a=this.options.transformAttributeName(a)),"__proto__"===a&&(a="#__proto__"),void 0!==o){this.options.trimValues&&(o=o.trim()),o=this.replaceEntitiesValue(o);const t=this.options.attributeValueProcessor(e,o,n);i[a]=null==t?o:typeof t!=typeof o||t!==o?t:k(o,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(i[a]=!0)}if(!Object.keys(i).length)return;if(this.options.attributesGroupName){const t={};return t[this.options.attributesGroupName]=i,t}return i}}const u=function(t){t=t.replace(/\r\n?/g,"\n");const r=new e("!xml");let o=r,i="",a="";for(let s=0;s<t.length;s++){if("<"===t[s])if("/"===t[s+1]){const e=y(t,">",s,"Closing Tag is not closed.");let n=t.substring(s+2,e).trim();if(this.options.removeNSPrefix){const t=n.indexOf(":");-1!==t&&(n=n.substr(t+1))}this.options.transformTagName&&(n=this.options.transformTagName(n)),o&&(i=this.saveTextToParentTag(i,o,a));const r=a.substring(a.lastIndexOf(".")+1);if(n&&-1!==this.options.unpairedTags.indexOf(n))throw new Error(`Unpaired tag can not be used as closing tag: </${n}>`);let l=0;r&&-1!==this.options.unpairedTags.indexOf(r)?(l=a.lastIndexOf(".",a.lastIndexOf(".")-1),this.tagsNodeStack.pop()):l=a.lastIndexOf("."),a=a.substring(0,l),o=this.tagsNodeStack.pop(),i="",s=e}else if("?"===t[s+1]){let n=h(t,s,!1,"?>");if(!n)throw new Error("Pi Tag is not closed.");if(i=this.saveTextToParentTag(i,o,a),this.options.ignoreDeclaration&&"?xml"===n.tagName||this.options.ignorePiTags);else{const t=new e(n.tagName);t.add(this.options.textNodeName,""),n.tagName!==n.tagExp&&n.attrExpPresent&&(t[":@"]=this.buildAttributesMap(n.tagExp,a,n.tagName)),this.addChild(o,t,a)}s=n.closeIndex+1}else if("!--"===t.substr(s+1,3)){const e=y(t,"--\x3e",s+4,"Comment is not closed.");if(this.options.commentPropName){const n=t.substring(s+4,e-2);i=this.saveTextToParentTag(i,o,a),o.add(this.options.commentPropName,[{[this.options.textNodeName]:n}])}s=e}else if("!D"===t.substr(s+1,2)){const e=n(t,s);this.docTypeEntities=e.entities,s=e.i}else if("!["===t.substr(s+1,2)){const e=y(t,"]]>",s,"CDATA is not closed.")-2,n=t.substring(s+9,e);i=this.saveTextToParentTag(i,o,a);let r=this.parseTextData(n,o.tagname,a,!0,!1,!0,!0);null==r&&(r=""),this.options.cdataPropName?o.add(this.options.cdataPropName,[{[this.options.textNodeName]:n}]):o.add(this.options.textNodeName,r),s=e+2}else{let n=h(t,s,this.options.removeNSPrefix),l=n.tagName;const c=n.rawTagName;let u=n.tagExp,d=n.attrExpPresent,p=n.closeIndex;this.options.transformTagName&&(l=this.options.transformTagName(l)),o&&i&&"!xml"!==o.tagname&&(i=this.saveTextToParentTag(i,o,a,!1));const g=o;if(g&&-1!==this.options.unpairedTags.indexOf(g.tagname)&&(o=this.tagsNodeStack.pop(),a=a.substring(0,a.lastIndexOf("."))),l!==r.tagname&&(a+=a?"."+l:l),this.isItStopNode(this.options.stopNodes,a,l)){let r="";if(u.length>0&&u.lastIndexOf("/")===u.length-1)"/"===l[l.length-1]?(l=l.substr(0,l.length-1),a=a.substr(0,a.length-1),u=l):u=u.substr(0,u.length-1),s=n.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(l))s=n.closeIndex;else{const e=this.readStopNodeData(t,c,p+1);if(!e)throw new Error(`Unexpected end of ${c}`);s=e.i,r=e.tagContent}const i=new e(l);l!==u&&d&&(i[":@"]=this.buildAttributesMap(u,a,l)),r&&(r=this.parseTextData(r,l,a,!0,d,!0,!0)),a=a.substr(0,a.lastIndexOf(".")),i.add(this.options.textNodeName,r),this.addChild(o,i,a)}else{if(u.length>0&&u.lastIndexOf("/")===u.length-1){"/"===l[l.length-1]?(l=l.substr(0,l.length-1),a=a.substr(0,a.length-1),u=l):u=u.substr(0,u.length-1),this.options.transformTagName&&(l=this.options.transformTagName(l));const t=new e(l);l!==u&&d&&(t[":@"]=this.buildAttributesMap(u,a,l)),this.addChild(o,t,a),a=a.substr(0,a.lastIndexOf("."))}else{const t=new e(l);this.tagsNodeStack.push(o),l!==u&&d&&(t[":@"]=this.buildAttributesMap(u,a,l)),this.addChild(o,t,a),o=t}i="",s=p}}else i+=t[s]}return r.child};function d(t,e,n){const r=this.options.updateTag(e.tagname,n,e[":@"]);!1===r||("string"==typeof r?(e.tagname=r,t.addChild(e)):t.addChild(e))}const p=function(t){if(this.options.processEntities){for(let e in this.docTypeEntities){const n=this.docTypeEntities[e];t=t.replace(n.regx,n.val)}for(let e in this.lastEntities){const n=this.lastEntities[e];t=t.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let e in this.htmlEntities){const n=this.htmlEntities[e];t=t.replace(n.regex,n.val)}t=t.replace(this.ampEntity.regex,this.ampEntity.val)}return t};function g(t,e,n,r){return t&&(void 0===r&&(r=0===e.child.length),void 0!==(t=this.parseTextData(t,e.tagname,n,!1,!!e[":@"]&&0!==Object.keys(e[":@"]).length,r))&&""!==t&&e.add(this.options.textNodeName,t),t=""),t}function m(t,e,n){const r="*."+n;for(const n in t){const o=t[n];if(r===o||e===o)return!0}return!1}function y(t,e,n,r){const o=t.indexOf(e,n);if(-1===o)throw new Error(r);return o+e.length-1}function h(t,e,n,r=">"){const o=function(t,e,n=">"){let r,o="";for(let i=e;i<t.length;i++){let e=t[i];if(r)e===r&&(r="");else if('"'===e||"'"===e)r=e;else if(e===n[0]){if(!n[1])return{data:o,index:i};if(t[i+1]===n[1])return{data:o,index:i}}else"\t"===e&&(e=" ");o+=e}}(t,e+1,r);if(!o)return;let i=o.data;const a=o.index,s=i.search(/\s/);let l=i,c=!0;-1!==s&&(l=i.substring(0,s),i=i.substring(s+1).trimStart());const u=l;if(n){const t=l.indexOf(":");-1!==t&&(l=l.substr(t+1),c=l!==o.data.substr(t+1))}return{tagName:l,tagExp:i,closeIndex:a,attrExpPresent:c,rawTagName:u}}function f(t,e,n){const r=n;let o=1;for(;n<t.length;n++)if("<"===t[n])if("/"===t[n+1]){const i=y(t,">",n,`${e} is not closed`);if(t.substring(n+2,i).trim()===e&&(o--,0===o))return{tagContent:t.substring(r,n),i:i};n=i}else if("?"===t[n+1]){n=y(t,"?>",n+1,"StopNode is not closed.")}else if("!--"===t.substr(n+1,3)){n=y(t,"--\x3e",n+3,"StopNode is not closed.")}else if("!["===t.substr(n+1,2)){n=y(t,"]]>",n,"StopNode is not closed.")-2}else{const r=h(t,n,">");if(r){(r&&r.tagName)===e&&"/"!==r.tagExp[r.tagExp.length-1]&&o++,n=r.closeIndex}}}function k(e,n,o){if(n&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&r(e,o)}return t.isExist(e)?e:""}return ge=class{constructor(t){this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(t,e)=>String.fromCharCode(Number.parseInt(e,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(t,e)=>String.fromCharCode(Number.parseInt(e,16))}},this.addExternalEntities=i,this.parseXml=u,this.parseTextData=a,this.resolveNameSpace=s,this.buildAttributesMap=c,this.isItStopNode=m,this.replaceEntitiesValue=p,this.readStopNodeData=f,this.saveTextToParentTag=g,this.addChild=d,this.ignoreAttributesFn=o(this.options.ignoreAttributes)}}}var Te,be,Ne,xe,Ce,Ae,Ie,Me,we,Ee={};function ve(){if(Te)return Ee;function t(o,i,a){let s;const l={};for(let c=0;c<o.length;c++){const u=o[c],d=e(u);let p="";if(p=void 0===a?d:a+"."+d,d===i.textNodeName)void 0===s?s=u[d]:s+=""+u[d];else{if(void 0===d)continue;if(u[d]){let e=t(u[d],i,p);const o=r(e,i);u[":@"]?n(e,u[":@"],p,i):1!==Object.keys(e).length||void 0===e[i.textNodeName]||i.alwaysCreateTextNode?0===Object.keys(e).length&&(i.alwaysCreateTextNode?e[i.textNodeName]="":e=""):e=e[i.textNodeName],void 0!==l[d]&&l.hasOwnProperty(d)?(Array.isArray(l[d])||(l[d]=[l[d]]),l[d].push(e)):i.isArray(d,p,o)?l[d]=[e]:l[d]=e}}}return"string"==typeof s?s.length>0&&(l[i.textNodeName]=s):void 0!==s&&(l[i.textNodeName]=s),l}function e(t){const e=Object.keys(t);for(let t=0;t<e.length;t++){const n=e[t];if(":@"!==n)return n}}function n(t,e,n,r){if(e){const o=Object.keys(e),i=o.length;for(let a=0;a<i;a++){const i=o[a];r.isArray(i,n+"."+i,!0,!0)?t[i]=[e[i]]:t[i]=e[i]}}}function r(t,e){const{textNodeName:n}=e,r=Object.keys(t).length;return 0===r||!(1!==r||!t[n]&&"boolean"!=typeof t[n]&&0!==t[n])}return Te=1,Ee.prettify=function(e,n){return t(e,n)},Ee}function Fe(){if(Ne)return be;Ne=1;const{buildOptions:t}=function(){if(oe)return ye;oe=1;const t={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(t,e){return e},attributeValueProcessor:function(t,e){return e},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(t,e,n){return t}};return ye.buildOptions=function(e){return Object.assign({},t,e)},ye.defaultOptions=t,ye}(),e=Se(),{prettify:n}=ve(),r=re();return be=class{constructor(e){this.externalEntities={},this.options=t(e)}parse(t,o){if("string"==typeof t);else{if(!t.toString)throw new Error("XML data is accepted in String or Bytes[] form.");t=t.toString()}if(o){!0===o&&(o={});const e=r.validate(t,o);if(!0!==e)throw Error(`${e.err.msg}:${e.err.line}:${e.err.col}`)}const i=new e(this.options);i.addExternalEntities(this.externalEntities);const a=i.parseXml(t);return this.options.preserveOrder||void 0===a?a:n(a,this.options)}addEntity(t,e){if(-1!==e.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==t.indexOf("&")||-1!==t.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===e)throw new Error("An entity with value '&' is not permitted");this.externalEntities[t]=e}}}function De(){if(Ce)return xe;Ce=1;function t(i,a,s,l){let c="",u=!1;for(let d=0;d<i.length;d++){const p=i[d],g=e(p);if(void 0===g)continue;let m="";if(m=0===s.length?g:`${s}.${g}`,g===a.textNodeName){let t=p[g];r(m,a)||(t=a.tagValueProcessor(g,t),t=o(t,a)),u&&(c+=l),c+=t,u=!1;continue}if(g===a.cdataPropName){u&&(c+=l),c+=`<![CDATA[${p[g][0][a.textNodeName]}]]>`,u=!1;continue}if(g===a.commentPropName){c+=l+`\x3c!--${p[g][0][a.textNodeName]}--\x3e`,u=!0;continue}if("?"===g[0]){const t=n(p[":@"],a),e="?xml"===g?"":l;let r=p[g][0][a.textNodeName];r=0!==r.length?" "+r:"",c+=e+`<${g}${r}${t}?>`,u=!0;continue}let y=l;""!==y&&(y+=a.indentBy);const h=l+`<${g}${n(p[":@"],a)}`,f=t(p[g],a,m,y);-1!==a.unpairedTags.indexOf(g)?a.suppressUnpairedNode?c+=h+">":c+=h+"/>":f&&0!==f.length||!a.suppressEmptyNode?f&&f.endsWith(">")?c+=h+`>${f}${l}</${g}>`:(c+=h+">",f&&""!==l&&(f.includes("/>")||f.includes("</"))?c+=l+a.indentBy+f+l:c+=f,c+=`</${g}>`):c+=h+"/>",u=!0}return c}function e(t){const e=Object.keys(t);for(let n=0;n<e.length;n++){const r=e[n];if(t.hasOwnProperty(r)&&":@"!==r)return r}}function n(t,e){let n="";if(t&&!e.ignoreAttributes)for(let r in t){if(!t.hasOwnProperty(r))continue;let i=e.attributeValueProcessor(r,t[r]);i=o(i,e),!0===i&&e.suppressBooleanAttributes?n+=` ${r.substr(e.attributeNamePrefix.length)}`:n+=` ${r.substr(e.attributeNamePrefix.length)}="${i}"`}return n}function r(t,e){let n=(t=t.substr(0,t.length-e.textNodeName.length-1)).substr(t.lastIndexOf(".")+1);for(let r in e.stopNodes)if(e.stopNodes[r]===t||e.stopNodes[r]==="*."+n)return!0;return!1}function o(t,e){if(t&&t.length>0&&e.processEntities)for(let n=0;n<e.entities.length;n++){const r=e.entities[n];t=t.replace(r.regex,r.val)}return t}return xe=function(e,n){let r="";return n.format&&n.indentBy.length>0&&(r="\n"),t(e,n,"",r)}}var Oe=function(){if(we)return Me;we=1;const t=re(),e=Fe(),n=function(){if(Ie)return Ae;Ie=1;const t=De(),e=ke(),n={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(t,e){return e},attributeValueProcessor:function(t,e){return e},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function r(t){this.options=Object.assign({},n,t),!0===this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.ignoreAttributesFn=e(this.options.ignoreAttributes),this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=a),this.processTextOrObjNode=o,this.options.format?(this.indentate=i,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function o(t,e,n,r){const o=this.j2x(t,n+1,r.concat(e));return void 0!==t[this.options.textNodeName]&&1===Object.keys(t).length?this.buildTextValNode(t[this.options.textNodeName],e,o.attrStr,n):this.buildObjectNode(o.val,e,o.attrStr,n)}function i(t){return this.options.indentBy.repeat(t)}function a(t){return!(!t.startsWith(this.options.attributeNamePrefix)||t===this.options.textNodeName)&&t.substr(this.attrPrefixLen)}return r.prototype.build=function(e){return this.options.preserveOrder?t(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0,[]).val)},r.prototype.j2x=function(t,e,n){let r="",o="";const i=n.join(".");for(let a in t)if(Object.prototype.hasOwnProperty.call(t,a))if(void 0===t[a])this.isAttribute(a)&&(o+="");else if(null===t[a])this.isAttribute(a)||a===this.options.cdataPropName?o+="":"?"===a[0]?o+=this.indentate(e)+"<"+a+"?"+this.tagEndChar:o+=this.indentate(e)+"<"+a+"/"+this.tagEndChar;else if(t[a]instanceof Date)o+=this.buildTextValNode(t[a],a,"",e);else if("object"!=typeof t[a]){const n=this.isAttribute(a);if(n&&!this.ignoreAttributesFn(n,i))r+=this.buildAttrPairStr(n,""+t[a]);else if(!n)if(a===this.options.textNodeName){let e=this.options.tagValueProcessor(a,""+t[a]);o+=this.replaceEntitiesValue(e)}else o+=this.buildTextValNode(t[a],a,"",e)}else if(Array.isArray(t[a])){const r=t[a].length;let i="",s="";for(let l=0;l<r;l++){const r=t[a][l];if(void 0===r);else if(null===r)"?"===a[0]?o+=this.indentate(e)+"<"+a+"?"+this.tagEndChar:o+=this.indentate(e)+"<"+a+"/"+this.tagEndChar;else if("object"==typeof r)if(this.options.oneListGroup){const t=this.j2x(r,e+1,n.concat(a));i+=t.val,this.options.attributesGroupName&&r.hasOwnProperty(this.options.attributesGroupName)&&(s+=t.attrStr)}else i+=this.processTextOrObjNode(r,a,e,n);else if(this.options.oneListGroup){let t=this.options.tagValueProcessor(a,r);t=this.replaceEntitiesValue(t),i+=t}else i+=this.buildTextValNode(r,a,"",e)}this.options.oneListGroup&&(i=this.buildObjectNode(i,a,s,e)),o+=i}else if(this.options.attributesGroupName&&a===this.options.attributesGroupName){const e=Object.keys(t[a]),n=e.length;for(let o=0;o<n;o++)r+=this.buildAttrPairStr(e[o],""+t[a][e[o]])}else o+=this.processTextOrObjNode(t[a],a,e,n);return{attrStr:r,val:o}},r.prototype.buildAttrPairStr=function(t,e){return e=this.options.attributeValueProcessor(t,""+e),e=this.replaceEntitiesValue(e),this.options.suppressBooleanAttributes&&"true"===e?" "+t:" "+t+'="'+e+'"'},r.prototype.buildObjectNode=function(t,e,n,r){if(""===t)return"?"===e[0]?this.indentate(r)+"<"+e+n+"?"+this.tagEndChar:this.indentate(r)+"<"+e+n+this.closeTag(e)+this.tagEndChar;{let o="</"+e+this.tagEndChar,i="";return"?"===e[0]&&(i="?",o=""),!n&&""!==n||-1!==t.indexOf("<")?!1!==this.options.commentPropName&&e===this.options.commentPropName&&0===i.length?this.indentate(r)+`\x3c!--${t}--\x3e`+this.newLine:this.indentate(r)+"<"+e+n+i+this.tagEndChar+t+this.indentate(r)+o:this.indentate(r)+"<"+e+n+i+">"+t+o}},r.prototype.closeTag=function(t){let e="";return-1!==this.options.unpairedTags.indexOf(t)?this.options.suppressUnpairedNode||(e="/"):e=this.options.suppressEmptyNode?"/":`></${t}`,e},r.prototype.buildTextValNode=function(t,e,n,r){if(!1!==this.options.cdataPropName&&e===this.options.cdataPropName)return this.indentate(r)+`<![CDATA[${t}]]>`+this.newLine;if(!1!==this.options.commentPropName&&e===this.options.commentPropName)return this.indentate(r)+`\x3c!--${t}--\x3e`+this.newLine;if("?"===e[0])return this.indentate(r)+"<"+e+n+"?"+this.tagEndChar;{let o=this.options.tagValueProcessor(e,t);return o=this.replaceEntitiesValue(o),""===o?this.indentate(r)+"<"+e+n+this.closeTag(e)+this.tagEndChar:this.indentate(r)+"<"+e+n+">"+o+"</"+e+this.tagEndChar}},r.prototype.replaceEntitiesValue=function(t){if(t&&t.length>0&&this.options.processEntities)for(let e=0;e<this.options.entities.length;e++){const n=this.options.entities[e];t=t.replace(n.regex,n.val)}return t},Ae=r}();return Me={XMLParser:e,XMLValidator:t,XMLBuilder:n}}();const Be={ignoreAttributes:!1,attributeNamePrefix:"@_",textNodeName:"#text",trimValues:!1,parseTagValue:!1,parseAttributeValue:!1},Pe={ignoreAttributes:!1,attributeNamePrefix:"@_",textNodeName:"#text",format:!0,indentBy:"\t",suppressEmptyNode:!1};let Le=null,$e=null;function Re(t){try{return JSON.stringify(t).slice(1,-1)}catch(t){const e=`[utils.kmet] Failed to encode text for JSON – ${t.message}`;throw console.error(C.red(e)),t}}function Ve(t){return $(t).replace(/\\/g,"\\\\")}function je(t,e={}){var n;try{const r=(Le||(Le=new Oe.XMLParser(Be)),Le).parse(t);return JSON.stringify(r,null,null===(n=e.pretty)||void 0===n||n?2:0)}catch(t){const e=`[utils.kmet] xmlToJson() failed – ${t.message}`;throw console.error(C.red(e)),t}}function Ue(t,e={}){try{const n="string"==typeof t?JSON.parse(t):t;return(e.minify?new Oe.XMLBuilder({...Pe,format:!1}):($e||($e=new Oe.XMLBuilder(Pe)),$e)).build(n)}catch(t){const e=`[utils.kmet] jsonToXml() failed – ${t.message}`;throw console.error(C.red(e)),t}}function We(t,e,n,r={}){let o;if(r.literal||"string"==typeof e){const t=("string"==typeof e?e:String(e)).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");o=new RegExp(t,r.ignoreCase?"gi":"g")}else o=e;return t.replace(o,n)}function Ke(){console.log(`\n${C.bold("KMET CLI – quick Keyboard Maestro text‑object helper")}\n\nExamples:\n  ${C.cyan("yarn kmet --encode-json --text 'He said \"hello\" <&>'")}\n  ${C.cyan("yarn kmet --encode-xml  --text '5 < 7 & 7 > 5'")}\n  ${C.cyan("yarn kmet --xml2json --file ./object.xml > object.json")}\n  ${C.cyan("yarn kmet --json2xml --file ./object.json > object.xml")}\n  ${C.cyan("yarn kmet --replace --file ./macro.json --find Local_ --to Global_ > out.json")}\n\nFlags:\n  --encode-json           Escape a plain string for JSON embedding.\n  --encode-xml            Escape a plain string for XML embedding.\n  --xml2json              Convert plist‑XML → JSON.\n  --json2xml              Convert JSON → plist‑XML.\n  --replace               Search & replace within file contents.\n  --text   <string>       Raw text for encode operations.\n  --file   <path>         Path to input file (XML or JSON).\n  --find   <pattern>      String/RegExp (default literal string) to search for.\n  --to     <string>       Replacement string (used with --replace).\n  --regex                 Treat --find as a regular expression.\n  --ignore-case           Case‑insensitive search.\n`)}try{require.main===module&&async function(){const t=await import("fs/promises"),e=function(t){const e={};for(let n=2;n<t.length;n++){const r=t[n];if(r.startsWith("--")){const[o,i]=r.split("=");if(void 0!==i)e[o.slice(2)]=i;else{const r=t[n+1];r&&!r.startsWith("--")?(e[o.slice(2)]=r,n++):e[o.slice(2)]=!0}}}return e}(process.argv);if(e["encode-json"])return e.text?void console.log(Re(String(e.text))):Ke();if(e["encode-xml"])return e.text?void console.log(Ve(String(e.text))):Ke();if(e.xml2json){if(!e.file)return Ke();const n=await t.readFile(String(e.file),"utf8");return void console.log(je(n))}if(e.json2xml){if(!e.file)return Ke();const n=await t.readFile(String(e.file),"utf8");return void console.log(Ue(n))}if(e.replace){if(!e.file||!e.find||void 0===e.to)return Ke();const n=We(await t.readFile(String(e.file),"utf8"),e.regex?new RegExp(String(e.find),e["ignore-case"]?"gi":"g"):String(e.find),String(e.to),{literal:!e.regex,ignoreCase:!!e["ignore-case"]});return void console.log(n)}Ke()}().catch(t=>{console.error(C.red("[KMET CLI] Uncaught error:"),t),process.exit(1)})}catch(t){}exports.KM_TOKENS=j,exports.buildEphemeralMacroXml=K,exports.createVirtualActivate=function(t={}){const{target:e="Front",specific:n={},allWindows:r=!1,reopenWindows:o=!1,alreadyActivatedAction:i="Normal",timeoutAborts:a=!0}=t;let s;if(console.log(C.cyan("[VirtualAction] ActivateApplication:"),C.yellowBright(JSON.stringify(t))),"Specific"===e){const{name:t,bundleIdentifier:e,path:r,match:o,newFile:i}=n,a={};e&&(a.BundleIdentifier=e),o&&(a.Match=o),t&&(a.Name=t),i&&(a.NewFile=i),r&&(a.Path=r);const l=V(Object.keys(a),"application"),c=["<dict>"];for(const t of l)c.push(`<key>${t}</key>`),c.push(`<string>${$(a[t])}</string>`);c.push("</dict>"),s=c.join("\n")}else s="<dict/>";const l=["\t<dict>",...O(),"\t\t<key>AllWindows</key>",r?"\t\t<true/>":"\t\t<false/>","\t\t<key>AlreadyActivatedActionType</key>",`\t\t<string>${i}</string>`,"\t\t<key>Application</key>",...s.split("\n").map(t=>"\t\t"+t),"\t\t<key>MacroActionType</key>","\t\t<string>ActivateApplication</string>","\t\t<key>ReopenWindows</key>",o?"\t\t<true/>":"\t\t<false/>","\t\t<key>TimeOutAbortsMacro</key>",a?"\t\t<true/>":"\t\t<false/>","\t</dict>"];return{toXml:()=>R(l.join("\n"))}},exports.createVirtualBreakFromLoop=function(){return Mt({cancelType:"BreakFromLoop"})},exports.createVirtualCancel=Mt,exports.createVirtualClearTypedStringBuffer=function(){const t=["\t<dict>",...O(),"\t\t<key>IsDisclosed</key>","\t\t<false/>","\t\t<key>MacroActionType</key>","\t\t<string>SystemAction</string>","\t\t<key>SystemAction</key>","\t\t<string>ClearTypedString</string>","\t</dict>"];return{toXml:()=>R(t.join("\n"))}},exports.createVirtualClickAtFoundImage=Wt,exports.createVirtualComment=function(t){const{title:e,text:n,rtfContent:r}=t,o=H(r||Q(n)).split("\n").map(t=>`\t\t${t}`).join("\n"),i=["\t<dict>",...O(),"\t\t<key>MacroActionType</key>","\t\t<string>Comment</string>","\t\t<key>StyledText</key>","\t\t<data>",o,"\t\t</data>","\t\t<key>Title</key>",`\t\t<string>${$(e)}</string>`,"\t</dict>"];return{toXml:()=>R(i.join("\n"))}},exports.createVirtualContinueLoop=function(){return Mt({cancelType:"ContinueLoop"})},exports.createVirtualCopy=function(t={}){const{notifyOnTimeout:e=!0,timeoutAborts:n=!0}=t,r=["\t<dict>","\t\t<key>Action</key>","\t\t<string>Copy</string>",...O(),"\t\t<key>IsDisclosed</key>","\t\t<false/>","\t\t<key>MacroActionType</key>","\t\t<string>CutCopyPaste</string>",...L({notifyOnTimeout:e,timeoutAborts:n}),"\t</dict>"];return{toXml:()=>R(r.join("\n"))}},exports.createVirtualCut=function(t={}){const{notifyOnTimeout:e=!0,timeoutAborts:n=!1}=t,r=["\t<dict>","\t\t<key>Action</key>","\t\t<string>Cut</string>",...O(),"\t\t<key>IsDisclosed</key>","\t\t<false/>","\t\t<key>MacroActionType</key>","\t\t<string>CutCopyPaste</string>",...L({notifyOnTimeout:e,timeoutAborts:n}),"\t</dict>"];return{toXml:()=>R(r.join("\n"))}},exports.createVirtualDisplayTextBriefly=function(t){return tt({text:U(t.text,t.tokenPreset),action:"DisplayBriefly",processingMode:t.processingMode,includeStyledText:!1})},exports.createVirtualDisplayTextWindow=et,exports.createVirtualFile=function(t){const{operation:e,source:n="",destination:r="",outputPath:o,stopOnFailure:i,notifyOnFailure:a}=t,s=["Reveal","Duplicate","Trash","Delete","RecursiveDelete"].includes(e)?"":r||"",l="CreateUnique"===e,c=l?null!=o?o:"":void 0,u=["\t<dict>",...O().map(t=>`\t\t${t}`),"\t\t<key>Destination</key>",`\t\t<string>${$(s)}</string>`,"\t\t<key>MacroActionType</key>","\t\t<string>File</string>",!1===a?"\t\t<key>NotifyOnFailure</key>\n\t\t<false/>":void 0,"\t\t<key>Operation</key>",`\t\t<string>${$(e)}</string>`,l?`\t\t<key>OutputPath</key>\n\t\t<string>${$(c)}</string>`:void 0,"\t\t<key>Source</key>",`\t\t<string>${$(n)}</string>`,!0===i?"\t\t<key>StopOnFailure</key>\n\t\t<true/>":void 0,"\t</dict>"].filter(Boolean);return{toXml:()=>R(u.join("\n"))}},exports.createVirtualGroup=function(t){console.log(C.cyan("[VirtualAction] Group:"),C.grey(JSON.stringify({name:t.name,actionCount:t.actions.length})));const{name:e,actions:n,timeOutAbortsMacro:r=!0}=t,o=n.map(t=>t.toXml()).join("\n"),i=["\t<dict>","\t\t<key>ActionName</key>",`\t\t<string>${$(e)}</string>`,...O(),"\t\t<key>Actions</key>","\t\t<array>",...o.split("\n").map(t=>t?"\t\t"+t:t),"\t\t</array>","\t\t<key>MacroActionType</key>","\t\t<string>Group</string>",...L({timeoutAborts:r}),"\t</dict>"];return{toXml:()=>R(i.join("\n"))}},exports.createVirtualIf=function(t){const{conditions:e,match:n="All",then:r,else:o=[],timeoutAborts:i=!0}=t,a=r.map(t=>t.toXml()).join("\n"),s=o.map(t=>t.toXml()).join("\n"),l=e.length>0?e.map(Gt).map(t=>t.split("\n").map(t=>"\t\t\t"+t).join("\n")).join("\n"):"",c=["\t<dict>","\t\t<key>ActionUID</key>",`\t\t<integer>${Math.floor(Date.now()/1e3)}</integer>`,"\t\t<key>Conditions</key>","\t\t<dict>","\t\t\t<key>ConditionList</key>",l?"\t\t\t<array>":"\t\t\t<array/>",...l?[l,"\t\t\t</array>"]:[],"\t\t\t<key>ConditionListMatch</key>",`\t\t\t<string>${n}</string>`,"\t\t</dict>","\t\t<key>ElseActions</key>",s?"\t\t<array>":"\t\t<array/>",...s?[s.split("\n").map(t=>"\t\t\t"+t).join("\n"),"\t\t</array>"]:[],"\t\t<key>MacroActionType</key>","\t\t<string>IfThenElse</string>","\t\t<key>ThenActions</key>",a?"\t\t<array>":"\t\t<array/>",...a?[a.split("\n").map(t=>"\t\t\t"+t).join("\n"),"\t\t</array>"]:[],"\t\t<key>TimeOutAbortsMacro</key>","\t\t"+(i?"<true/>":"<false/>"),"\t</dict>"];return{toXml:()=>R(c.join("\n"))}},exports.createVirtualInsertText=tt,exports.createVirtualManipulateWindow=function(t={}){const{manipulation:e="CenterWindow",values:n=["0","0"],moveAndResizePreset:r="Custom",customValues:o,windowTarget:i="FrontWindow",windowIdentifier:a="",windowIndex:s=1,applicationTarget:l="Front",specificApplication:c={},stopOnFailure:u,notifyOnFailure:d}=t,p=e;let g=n[0],m=n[1],y=n[0],h=n[1];if(["ResizeBy","ResizeTo","ResizeWindowByPercent","ScaleBy","MoveBy","MoveTo","MoveWindowBy","MoveWindowTo","MoveAndResize","Center","CenterAt","Close","Zoom","Minimize","ReallyMinimizeWindow","Unminimize","ToggleMinimize","BringToFront","SelectWindow"].includes(p))if("MoveAndResize"===e){let t;t=o&&4===o.length?[o[0],o[1],o[2],o[3]]:function(t){switch(t){case"Custom":case"FullScreen":default:return["SCREENVISIBLE(Main,Left)","SCREENVISIBLE(Main,Top)","SCREENVISIBLE(Main,Width)","SCREENVISIBLE(Main,Height)"];case"LeftColumn":return["SCREENVISIBLE(Main,Left)","SCREENVISIBLE(Main,Top)","SCREENVISIBLE(Main,Width)*50%","SCREENVISIBLE(Main,Height)"];case"RightColumn":return["SCREENVISIBLE(Main,MidX)","SCREENVISIBLE(Main,Top)","SCREENVISIBLE(Main,Width)*50%","SCREENVISIBLE(Main,Height)"];case"TopHalf":return["SCREENVISIBLE(Main,Left)","SCREENVISIBLE(Main,Top)","SCREENVISIBLE(Main,Width)","SCREENVISIBLE(Main,Height)*50%"];case"BottomHalf":return["SCREENVISIBLE(Main,Left)","SCREENVISIBLE(Main,MidY)","SCREENVISIBLE(Main,Width)","SCREENVISIBLE(Main,Height)*50%"];case"TopLeft":return["SCREENVISIBLE(Main,Left)","SCREENVISIBLE(Main,Top)","SCREENVISIBLE(Main,Width)*50%","SCREENVISIBLE(Main,Height)*50%"];case"TopRight":return["SCREENVISIBLE(Main,MidX)","SCREENVISIBLE(Main,Top)","SCREENVISIBLE(Main,Width)*50%","SCREENVISIBLE(Main,Height)*50%"];case"BottomLeft":return["SCREENVISIBLE(Main,Left)","SCREENVISIBLE(Main,MidY)","SCREENVISIBLE(Main,Width)*50%","SCREENVISIBLE(Main,Height)*50%"];case"BottomRight":return["SCREENVISIBLE(Main,MidX)","SCREENVISIBLE(Main,MidY)","SCREENVISIBLE(Main,Width)*50%","SCREENVISIBLE(Main,Height)*50%"]}}(r),g=t[0],m=t[1],y=t[2],h=t[3]}else"CenterWindowAt"===e&&o&&o.length>=3?(g=o[0],m=o[1],y=o[2],h=o[2]):o&&o.length>=2&&(g=o[0],m=o[1]);let f=[];"KMWindowID"!==i&&"KMLastWindow"!==i&&(f="Specific"===l?["\t\t<key>TargetApplication</key>",...Jt(l,c).map(t=>"\t\t"+t)]:["\t\t<key>TargetApplication</key>","\t\t<dict/>"]);const k=["\t<dict>","\t\t<key>Action</key>",`\t\t<string>${p}</string>`,...O().map(t=>"\t\t"+t.trim()),"\t\t<key>HeightExpression</key>",`\t\t<string>${$(h)}</string>`,"\t\t<key>HorizontalExpression</key>",`\t\t<string>${$(g)}</string>`,"\t\t<key>MacroActionType</key>","\t\t<string>ManipulateWindow</string>",...void 0!==d?P(d):[],...void 0!==u?B(u):[],...f,"\t\t<key>Targeting</key>",`\t\t<string>${i}</string>`,..."KMWindowID"!==i&&"KMLastWindow"!==i?["\t\t<key>TargetingType</key>",`\t\t<string>${l}</string>`]:[],"\t\t<key>VerticalExpression</key>",`\t\t<string>${$(m)}</string>`,"\t\t<key>WidthExpression</key>",`\t\t<string>${$(y)}</string>`,..."KMWindowID"===i?["\t\t<key>WindowID</key>",`\t\t<string>${$(a)}</string>`,"\t\t<key>WindowIndexExpression</key>","\t\t<string></string>","\t\t<key>WindowName</key>","\t\t<string></string>"]:"WindowIndex"===i?["\t\t<key>WindowIndexExpression</key>",`\t\t<string>${s}</string>`,"\t\t<key>WindowName</key>","\t\t<string></string>"]:"NamedWindow"===i||"WindowNameContaining"===i||"WindowNameMatching"===i?["\t\t<key>WindowIndexExpression</key>","\t\t<string></string>","\t\t<key>WindowName</key>",`\t\t<string>${$(a)}</string>`]:["\t\t<key>WindowIndexExpression</key>","\t\t<string>2</string>","\t\t<key>WindowName</key>","\t\t<string></string>"],"\t</dict>"];return{toXml:()=>R(k.join("\n"))}},exports.createVirtualMoveAndClick=function(t={}){const{clickKind:e="Click",button:n="Left",clickModifiers:r=0,horizontal:o=0,vertical:i=0,relative:a="Window",relativeCorner:s="TopLeft",mouseDrag:l="None",dragTargetX:c=0,dragTargetY:u=0,restoreMouseLocation:d=!1}=t;return Wt({clickKind:e,button:n,clickModifiers:r,horizontal:o,vertical:i,relative:a,relativeCorner:s,mouseDrag:l,dragTargetX:c,dragTargetY:u,restoreMouseLocation:d,fuzz:15,imageSelection:"Unique"})},exports.createVirtualNotification=lt,exports.createVirtualOpen=function(t){const{path:e,target:n="Front",specific:r={},stopOnFailure:o=!0,notifyOnFailure:i=!0}=t,a="Front"===n||!r||0===Object.keys(r).length,s=["\t<dict>",...O(),...a?[]:["\t\t<key>Application</key>",...Jt(n,r).map(t=>`\t\t${t}`)],"\t\t<key>IsDefaultApplication</key>",a?"\t\t<true/>":"\t\t<false/>","\t\t<key>MacroActionType</key>","\t\t<string>Open1File</string>",...!1===i?P(!1):[],"\t\t<key>Path</key>",`\t\t<string>${$(e)}</string>`,...!1===o?B(!1):[],"\t</dict>"];return{toXml:()=>R(s.join("\n"))}},exports.createVirtualOpenURL=function(t){const{url:e,target:n="Front",specific:r={},processingMode:o,openInBackground:i=!1,stopOnFailure:a=!0,notifyOnFailure:s=!0,timeoutAborts:l=!0,notifyOnTimeout:c=!0}=t,u="Front"===n||!r||0===Object.keys(r).length,d=L({notifyOnTimeout:c,timeoutAborts:l}),p=d.findIndex(t=>t.includes("NotifyOnTimeOut")),g=-1!==p?d.slice(p,p+2):[],m=d.slice(-2),y=["\t<dict>",...O(),...u?[]:["\t\t<key>Application</key>",...Jt(n,r).map(t=>`\t\t${t}`)],"\t\t<key>IsDefaultApplication</key>",u?"\t\t<true/>":"\t\t<false/>","\t\t<key>MacroActionType</key>","\t\t<string>OpenURL</string>",...!1===s?P(!1):[],...g,...i?["\t\t<key>OpenInBackground</key>","\t\t<true/>"]:[],...o?["\t\t<key>ProcessingMode</key>",`\t\t<string>${o}</string>`]:[],...!1===a?B(!1):[],...m,"\t\t<key>URL</key>",`\t\t<string>${$(e)}</string>`,"\t</dict>"];return{toXml:()=>R(y.join("\n"))}},exports.createVirtualPaste=function(t={}){const{notifyOnTimeout:e=!0,timeoutAborts:n=!1}=t,r=["\t<dict>","\t\t<key>Action</key>","\t\t<string>Paste</string>",...O(),"\t\t<key>IsDisclosed</key>","\t\t<false/>","\t\t<key>MacroActionType</key>","\t\t<string>CutCopyPaste</string>",...L({notifyOnTimeout:e,timeoutAborts:n}),"\t</dict>"];return{toXml:()=>R(r.join("\n"))}},exports.createVirtualPause=_t,exports.createVirtualPlaySound=st,exports.createVirtualPressButton=function(t){const{action:e,buttonName:n,waitForEnabledButton:r=!1,timeoutAborts:o=!0,notifyOnTimeout:i=!0,stopOnFailure:a,notifyOnFailure:s}=t,l=Yt[e],c=["\t<dict>",...l?["\t\t<key>AXAction</key>",`\t\t<string>${l}</string>`]:[],...O(),"\t\t<key>ButtonName</key>",`\t\t<string>${$(n)}</string>`,"\t\t<key>MacroActionType</key>","\t\t<string>PressButton</string>",...P(s),...r&&(!0===o&&!1===i||!1===o&&!0===i)?["\t\t<key>NotifyOnTimeOut</key>",i?"\t\t<true/>":"\t\t<false/>"]:[],...!1===a?["\t\t<key>StopOnFailure</key>","\t\t<false/>"]:[],...r?["\t\t<key>TimeOutAbortsMacro</key>",o?"\t\t<true/>":"\t\t<false/>"]:[],...r?["\t\t<key>WaitForEnabledButton</key>","\t\t<true/>"]:[],"\t</dict>"];return{toXml:()=>R(c.join("\n"))}},exports.createVirtualQuit=function(t={}){const{variant:e="Quit",target:n="Front",specific:r={},timeoutAborts:o=!0}=t,i=Jt(n,r),a=["\t<dict>","\t\t<key>Action</key>",`\t\t<string>${e}</string>`,...O(),"\t\t<key>Application</key>",...i.map(t=>`\t\t${t}`),"\t\t<key>MacroActionType</key>","\t\t<string>QuitSpecificApp</string>","\t\t<key>Target</key>",`\t\t<string>${n}</string>`,"\t\t<key>TimeOutAbortsMacro</key>",o?"\t\t<true/>":"\t\t<false/>","\t</dict>"];return{toXml:()=>R(a.join("\n"))}},exports.createVirtualRetryThisLoop=function(){return Mt({cancelType:"RetryThisLoop"})},exports.createVirtualReturn=W,exports.createVirtualScreenCapture=function(t={}){const{screenArea:e={type:"ScreenAll"},destination:n,alwaysNominalResolution:r=!1,stopOnFailure:o=!1,notifyOnFailure:i=!0}=t,a=["\t<dict>",...O(),"\t\t<key>AlwaysNominalResolution</key>","\t\t<"+(r?"true":"false")+"/>",...zt(n),"\t\t<key>IncludeShadows</key>","\t\t<true/>","\t\t<key>MacroActionType</key>","\t\t<string>ScreenCapture</string>",...!1===i?P(i):[],...wt("ScreenArea",e).split("\n").map(function(t){return"\t\t"+t}),...!0===o?B(o):[],"\t</dict>"];return{toXml:()=>R(a.join("\n"))}},exports.createVirtualScrollWheelEvent=function(t){const{scrollAmount:e,direction:n,stopOnFailure:r,notifyOnFailure:o,actionUID:i}=t,a=["\t<dict>",...void 0!==i?["\t<key>ActionUID</key>",`\t<integer>${i}</integer>`]:O(),"\t<key>MacroActionType</key>","\t<string>ScrollWheelEvent</string>",...P(o),"\t<key>ScrollAmountExpression</key>",`\t<string>${e}</string>`,"\t<key>ScrollDirection</key>",`\t<string>${n}</string>`,...B(r),"\t</dict>"];return{toXml:()=>R(a.join("\n"))}},exports.createVirtualSetClipboardToText=function(t={}){const{text:e="",presetMode:n,processingMode:r,includeStyledText:o=!1,rtfContent:i,destination:a,stopOnFailure:s,notifyOnFailure:l}=t;let c=e;"delete"===n?c="%Delete%":"positionCursor"===n?c="%|%":n&&n in j&&(c=j[n]);let u="";if(o){let t=i;t||(t=Q(e));try{const e=H(t);u=["\t\t<key>StyledText</key>","\t\t<data>",e.split("\n").map(t=>`\t\t${t}`).join("\n"),"\t\t</data>"].join("\n"),i&&(c=Z(t))}catch(t){console.warn(`[setClipboardToText] Failed to encode styled text, falling back to plain text: ${t}`)}}zt(a);let d=[];"TriggerClipboard"===a?d=["\t\t<key>TargetUseTriggerClipboard</key>","\t\t<true/>"]:a&&"object"==typeof a&&"name"in a&&(d=["\t\t<key>TargetNamedClipboardRedundantDisplayName</key>",`\t\t<string>${a.name}</string>`,...a.uid?["\t\t<key>TargetNamedClipboardUID</key>",`\t\t<string>${a.uid}</string>`]:[],"\t\t<key>TargetUseNamedClipboard</key>","\t\t<true/>"]);const p=["\t<dict>",...O(),"\t\t<key>JustDisplay</key>","\t\t<false/>","\t\t<key>MacroActionType</key>","\t\t<string>SetClipboardToText</string>",...P(l),...r?X(r):[],...B(s),...u?[u]:[],...d,"\t\t<key>Text</key>",`\t\t<string>${$(c)}</string>`,"\t</dict>"];return{toXml:()=>R(p.join("\n"))}},exports.createVirtualSetVariable=function(t){const{variable:e,text:n="",processingMode:r,where:o,presetMode:i,scope:a="global"}=t;let s=n;"delete"===i?s="%Delete%":"positionCursor"===i?s="%|%":i&&i in j&&(s=j[i]);let l=e;"local"===a?l=`LOCAL${e}`:"instance"===a&&(l=`INSTANCE${e}`);const c=["\t<dict>",...O(),"\t\t<key>MacroActionType</key>","\t\t<string>SetVariableToText</string>",...X(r),"\t\t<key>Text</key>",`\t\t<string>${$(s)}</string>`,"\t\t<key>Variable</key>",`\t\t<string>${$(l)}</string>`,...G(o),"\t</dict>"];return{toXml:()=>R(c.join("\n"))}},exports.createVirtualSetVariableToCalculation=function(t){const{variable:e,text:n,format:r,stopOnFailure:o,notifyOnFailure:i}=t,a=["\t<dict>",...O(),...r?["\t\t<key>Format</key>",`\t\t<string>${$(r)}</string>`]:[],"\t\t<key>MacroActionType</key>","\t\t<string>SetVariableToCalculation</string>",...!1===i?P(!1):[],...!1===o?B(!1):[],"\t\t<key>Text</key>",`\t\t<string>${$(n)}</string>`,"\t\t<key>UseFormat</key>",r?"\t\t<true/>":"\t\t<false/>","\t\t<key>Variable</key>",`\t\t<string>${$(e)}</string>`,"\t</dict>"];return{toXml:()=>R(a.join("\n"))}},exports.createVirtualShowSpecificApp=function(t){const{target:e="Specific",specific:n}=t,r=Jt(e,n),o=["\t<dict>",...O(),"\t\t<key>Application</key>",...r.map(t=>`\t\t${t}`),"\t\t<key>MacroActionType</key>","\t\t<string>ShowSpecificApp</string>","\t</dict>"];return{toXml:()=>R(o.join("\n"))}},exports.createVirtualShowStatusMenu=function(t={}){const e=["\t<dict>",...O(),"\t\t<key>IsDisclosed</key>","\t\t<false/>","\t\t<key>MacroActionType</key>","\t\t<string>SystemAction</string>","\t\t<key>SystemAction</key>","\t\t<string>ShowStatusMenu</string>","\t</dict>"];return{toXml:()=>R(e.join("\n"))}},exports.createVirtualSwitchCase=function(t){const{source:e,variable:n,text:r="",textProcessingMode:o,calculation:i="",environmentVariable:a="",path:s="",namedClipboard:l,cases:c}=t;if(!c||0===c.length)throw new Error("SwitchCase requires at least one case entry.");const u=c.map(t=>{var e,n;const r=(null!==(e=t.actions)&&void 0!==e?e:[]).map(t=>t.toXml().split("\n").map(t=>"\t\t\t\t\t"+t).join("\n")).join("\n"),o=t.actions&&t.actions.length?["\t\t\t\t<array>",r,"\t\t\t\t</array>"].join("\n"):"\t\t\t\t<array/>",i=null!==(n=t.testValue)&&void 0!==n?n:"";return["\t\t\t<dict>","\t\t\t\t<key>Actions</key>",o,"\t\t\t\t<key>ConditionType</key>",`\t\t\t\t<string>${t.operator}</string>`,"\t\t\t\t<key>TestValue</key>",""===i?"\t\t\t\t<string/>":`\t\t\t\t<string>${i}</string>`,"\t\t\t</dict>"].join("\n")}).join("\n"),d=["\t<dict>","\t\t<key>ActionUID</key>",`\t\t<integer>${Math.floor(Date.now()/1e3)}</integer>`,..."Calculation"===e?["\t\t<key>Calculation</key>",i?`\t\t<string>${i}</string>`:"\t\t<string/>"]:[],"\t\t<key>CaseEntries</key>",c.length?"\t\t<array>":"\t\t<array/>",...c.length?[u,"\t\t</array>"]:[],"\t\t<key>MacroActionType</key>","\t\t<string>Switch</string>",..."File"===e?["\t\t<key>Path</key>",""===s?"\t\t<string/>":`\t\t<string>${s}</string>`]:[],"\t\t<key>Source</key>",`\t\t<string>${e}</string>`,..."Variable"===e?["\t\t<key>Variable</key>",n&&""!==n?`\t\t<string>${n}</string>`:"\t\t<string/>"]:"Text"===e?Ht(r,o):"EnvironmentVariable"===e?["\t\t<key>Text</key>",""===a?"\t\t<string/>":`\t\t<string>${a}</string>`]:"NamedClipboard"===e&&l?["\t\t<key>ClipboardSourceNamedClipboardUID</key>",`\t\t<string>${l.uid}</string>`,"\t\t<key>ClipboardSourceNamedClipboardRedundantDisplayName</key>",`\t\t<string>${l.redundantDisplayName}</string>`]:[],"\t</dict>"];return{toXml:()=>R(d.join("\n"))}},exports.createVirtualTypeKeystroke=function(t){console.log(C.cyan("[VirtualAction] TypeKeystroke:"),C.grey(JSON.stringify(t)));const{keystroke:e,pressAndHold:n=!1,pressAndRepeat:r=!1,holdTime:o}=t;if(r&&(n||void 0!==o))throw new Error("pressAndRepeat cannot be combined with pressAndHold or holdTime");const i=void 0!==o||n,a=Vt(e),[[s,l]]=Object.entries(a).map(([t,e])=>[Number(t),e]);if(null===l)throw new Error(`TypeKeystroke action requires a key, but received modifier-only keystroke: ${JSON.stringify(e)}. Modifier-only keystrokes (like "Cmd" or "Shift") cannot be used with typeKeystroke actions.`);const c=t=>{const e=["\t<dict>",...O(),"\t\t<key>KeyCode</key>",`\t\t<integer>${l}</integer>`,"\t\t<key>MacroActionType</key>","\t\t<string>SimulateKeystroke</string>","\t\t<key>Modifiers</key>",`\t\t<integer>${s}</integer>`,t?"\t\t<key>Press</key>":"",t?`\t\t<string>${t}</string>`:"","\t\t<key>ReleaseAll</key>","\t\t<false/>","\t\t<key>TargetApplication</key>","\t\t<dict/>","\t\t<key>TargetingType</key>","\t\t<string>Front</string>","\t</dict>"].filter(Boolean).join("\n");return{toXml:()=>R(e)}};if(i){const t=[c("PressAndHold"),_t(void 0!==o?{time:o}:{}),c("Release")];return{toXml:()=>t.map(t=>t.toXml().trim()).join("\n")}}return r?c("PressAndRepeat"):c()},exports.createVirtualUseVariable=function(t){const{variable:e,action:n,stopOnFailure:r=!1,notifyOnFailure:o=!0}=t,i=["\t<dict>","\t\t<key>Action</key>","\t\t<string>"+n+"</string>",...O(),"\t\t<key>MacroActionType</key>","\t\t<string>UseVariable</string>",...!1===o?P(o):[],...!0===r?B(r):[],"\t\t<key>Variable</key>","\t\t<string>"+(e||"")+"</string>","\t</dict>"];return{toXml:()=>R(i.join("\n"))}},exports.createVirtualWhile=function(t){const{conditions:e,match:n="All",actions:r,timeoutAborts:o=!0,notifyOnTimeout:i}=t,a=r.map(t=>t.toXml()).join("\n"),s=e.length>0?e.map(Gt).map(t=>t.split("\n").map(t=>"\t\t\t"+t).join("\n")).join("\n"):"",l=["\t<dict>","\t\t<key>ActionUID</key>",`\t\t<integer>${Math.floor(Date.now()/1e3)}</integer>`,"\t\t<key>Actions</key>",a?"\t\t<array>":"\t\t<array/>",...a?[a.split("\n").map(t=>"\t\t\t"+t).join("\n"),"\t\t</array>"]:[],"\t\t<key>Conditions</key>","\t\t<dict>","\t\t\t<key>ConditionList</key>",s?"\t\t\t<array>":"\t\t\t<array/>",...s?[s,"\t\t\t</array>"]:[],"\t\t\t<key>ConditionListMatch</key>",`\t\t\t<string>${n}</string>`,"\t\t</dict>","\t\t<key>MacroActionType</key>","\t\t<string>While</string>",...void 0!==i?["\t\t<key>NotifyOnTimeOut</key>","\t\t"+(i?"<true/>":"<false/>")]:[],"\t\t<key>TimeOutAbortsMacro</key>","\t\t"+(o?"<true/>":"<false/>"),"\t</dict>"];return{toXml:()=>R(l.join("\n"))}},exports.createVirtualselectMenuItem=function(t){const{target:e="Front",specific:n={},menuPath:r,stopOnFailure:o,notifyOnFailure:i}=t;if(!r||!Array.isArray(r)||0===r.length)throw new Error("menuPath (array of menu/submenu strings) is required");const a=Jt(e,n),s=["\t\t<key>Menu</key>","\t\t<array>",...r.map(t=>`\t\t\t<string>${null!=t?t:""}</string>`),"\t\t</array>"],l=["\t<dict>",...O(),"\t\t<key>MacroActionType</key>","\t\t<string>SelectMenuItem</string>",...s,...P(i),...function(t){return!1===t?["\t\t<key>StopOnFailure</key>","\t\t<false/>"]:[]}(o),"\t\t<key>TargetApplication</key>",...a.map(t=>`\t\t${t}`),"\t\t<key>TargetingType</key>",`\t\t<string>${e}</string>`,"\t</dict>"];return{toXml:()=>R(l.join("\n"))}},exports.decodeStyledTextData=_,exports.encodeStyledTextData=H,exports.encodeTextForJson=Re,exports.encodeTextForXml=Ve,exports.generateBasicRtf=Q,exports.generateMacro=function(t,e={}){const{addPlistWrapping:n=!1,exportTarget:r={},macroName:o="Generated Macro"}=e;0===t.length&&console.log(C.yellow("No actions provided - generating empty macro XML."));const i=t.map(t=>t.toXml()).join("\n"),a=n||r.filePath||r.toKMGroup,s=a?F+i+"\n"+D:i;if(console.log(C.gray(`Generated XML for ${t.length} action(s)${a?" with plist wrapping":""}`)),r.displayInTextWindow&&function(t){console.log(C.blue("Displaying XML in Keyboard Maestro text window..."));q([et({text:t,processingMode:"Nothing"})],"Display Generated XML")}(s),r.filePath)try{!function(t,e,n){const r=require("fs"),o=require("path"),i=e.endsWith(".kmmacros")?e:`${e}.kmmacros`;try{const e=o.dirname(i);r.existsSync(e)||r.mkdirSync(e,{recursive:!0}),r.writeFileSync(i,t,"utf8");const a=r.statSync(i);console.log(C.green(`✅ Exported "${n}" to ${i} (${a.size} bytes)`))}catch(t){throw console.error(C.red(`❌ Failed to export to file: ${t instanceof Error?t.message:String(t)}`)),t}}(s,r.filePath,o)}catch(t){if("test"!==process.env.NODE_ENV&&!process.env.VITEST)throw t;console.warn(`File export skipped in test environment: ${t instanceof Error?t.message:String(t)}`)}if(r.toKMGroup)try{!function(t,e,n){const r=require("fs"),o=require("path"),i=require("os");console.log(C.blue(`Importing "${n}" to KM group "${e}"...`));const a=function(t,e,n){const r=Date.now().toString(),o=(Date.now()+1).toString(),i=Date.now()/1e3,a=["\t\t\t<dict>","\t\t\t\t<key>Actions</key>","\t\t\t\t<array>",...t.split("\n").map(t=>t?`\t\t\t\t\t${t}`:""),"\t\t\t\t</array>","\t\t\t\t<key>CreationDate</key>",`\t\t\t\t<real>${i}</real>`,"\t\t\t\t<key>ModificationDate</key>",`\t\t\t\t<real>${i}</real>`,"\t\t\t\t<key>Name</key>",`\t\t\t\t<string>${e}</string>`,"\t\t\t\t<key>Triggers</key>","\t\t\t\t<array/>","\t\t\t\t<key>UID</key>",`\t\t\t\t<string>${r}</string>`,"\t\t\t</dict>"].join("\n"),s=['<?xml version="1.0" encoding="UTF-8"?>','<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">','<plist version="1.0">',"<array>","\t<dict>","\t\t<key>Activate</key>","\t\t<string>Normal</string>","\t\t<key>CreationDate</key>",`\t\t<real>${i}</real>`,"\t\t<key>Macros</key>","\t\t<array>",a,"\t\t</array>","\t\t<key>Name</key>",`\t\t<string>${n}</string>`,"\t\t<key>ToggleMacroUID</key>","\t\t<string>00000000-0000-0000-0000-000000000000</string>","\t\t<key>UID</key>",`\t\t<string>${o}</string>`,"\t</dict>","</array>","</plist>"].join("\n");return s}(t,n,e),s=o.join(i.tmpdir(),`kmjs-generated-${Date.now()}.kmmacros`);try{r.writeFileSync(s,a,"utf8"),console.log(C.gray(`Deleting existing macro "${n}" if present...`));const t=v();0===t("osascript",["-e",`tell application "Keyboard Maestro" to deleteMacro "${n}"`],{encoding:"utf8"}).status?console.log(C.gray(`Deleted existing macro "${n}"`)):console.log(C.gray(`No existing macro "${n}" to delete`));const o=t("osascript",["-e",`tell application "Keyboard Maestro" to importMacros (POSIX file "${s}" as alias)`],{encoding:"utf8"});if(0!==o.status)throw new Error(`Import failed: ${o.stderr.trim()||o.stdout.trim()}`);console.log(C.green(`✅ Successfully imported "${n}" to group "${e}"`))}catch(t){throw console.error(C.red(`❌ Failed to import to KM group: ${t instanceof Error?t.message:String(t)}`)),t}finally{try{r.existsSync(s)&&r.unlinkSync(s)}catch(t){console.warn(C.yellow(`Warning: Could not delete temp file ${s}`))}}}(i,r.toKMGroup,o)}catch(t){if("test"!==process.env.NODE_ENV&&!process.env.VITEST)throw t;console.warn(`KM group export skipped in test environment: ${t instanceof Error?t.message:String(t)}`)}return s},exports.getFinderSelections=mt,exports.getFrontAppInfo=pt,exports.getFrontWindowInfo=gt,exports.getMousePosition=dt,exports.getNetworkInfo=St,exports.getPastClipboard=Nt,exports.getRunningApps=kt,exports.getScreenFrames=ft,exports.getScreenResolution=xt,exports.getSystemClipboard=yt,exports.getSystemVersion=bt,exports.getSystemVolume=ht,exports.getUserInfo=Tt,exports.getVariable=ot,exports.jsonToXml=Ue,exports.kmvar=at,exports.lookupKMToken=function(t,e){var n,r;!function(){if(!ut)try{let t=[],e=!1;try{t=require("./data/km.tokens.mapping.json"),e=!0}catch(n){const r=require("fs"),o=require("path");if("function"==typeof r.readFileSync){const n=[o.resolve(__dirname,"./data/km.tokens.mapping.json"),o.resolve(__dirname,"./tokens/data/km.tokens.mapping.json"),o.resolve(__dirname,"../tokens/data/km.tokens.mapping.json")];for(const o of n)try{if(("function"==typeof r.existsSync?r.existsSync:()=>!1)(o)){t=JSON.parse(r.readFileSync(o,"utf8")),e=!0;break}}catch(t){}}if(!e)try{t=[{human:"A Random Unique ID",pascal:"ARandomUniqueID",token:"%RandomUUID%"},{human:"AddressBook Email",pascal:"AddressBookEmail",token:"%AddressBook%Email%"},{human:"AddressBook First Name",pascal:"AddressBookFirstName",token:"%AddressBook%First%"},{human:"AddressBook Last Name",pascal:"AddressBookLastName",token:"%AddressBook%Last%"},{human:"AddressBook Name",pascal:"AddressBookName",token:"%AddressBook%Name%"},{human:"AddressBook Nickname",pascal:"AddressBookNickname",token:"%AddressBook%Nickname%"},{human:"AddressBook Note",pascal:"AddressBookNote",token:"%AddressBook%Note%"},{human:"AddressBook Organization",pascal:"AddressBookOrganization",token:"%AddressBook%Organization%"},{human:"All Audio Input Devices",pascal:"AllAudioInputDevices",token:"%AudioInputDevices%"},{human:"All Audio Output Devices",pascal:"AllAudioOutputDevices",token:"%AudioOutputDevices%"},{human:"All Background Application Names",pascal:"AllBackgroundApplicationNames",token:"%Application%Background%"},{human:"All Foreground Application Names",pascal:"AllForegroundApplicationNames",token:"%Application%Foreground%"},{human:"All Running Application Names",pascal:"AllRunningApplicationNames",token:"%Application%All%"},{human:"All Screen Frames",pascal:"AllScreenFrames",token:"%Screen%All%"},{human:"All Window Names",pascal:"AllWindowNames",token:"%WindowName%All%"},{human:"Calculation",pascal:"Calculation",token:"%Calculate%1+2%"},{human:"Calculation with Result in Binary",pascal:"CalculationWithResultInBinary",token:"%Bin8%1+2%"},{human:"Calculation with Result in Decimal",pascal:"CalculationWithResultInDecimal",token:"%Dec2%1+2%"},{human:"Calculation with Result in Hex",pascal:"CalculationWithResultInHex",token:"%Hex2%1+2%"},{human:"Calculation with Result in Octal",pascal:"CalculationWithResultInOctal",token:"%Oct3%1+2%"},{human:"Comma-separated list of the current execution instances",pascal:"CommaSeparatedListOfTheCurrentExecutionInstances",token:"%ExecutingInstances%"},{human:"Comma-separated list of variables accessed by this macro",pascal:"CommaSeparatedListOfVariablesAccessedByThisMacro",token:"%AccessedVariables%"},{human:"Current Audio Input Device",pascal:"CurrentAudioInputDevice",token:"%AudioInputDevice%"},{human:"Current Audio Input Device UID",pascal:"CurrentAudioInputDeviceUID",token:"%AudioInputDeviceUID%"},{human:"Current Audio Output Device",pascal:"CurrentAudioOutputDevice",token:"%AudioOutputDevice%"},{human:"Current Audio Output Device UID",pascal:"CurrentAudioOutputDeviceUID",token:"%AudioOutputDeviceUID%"},{human:"Current Audio Sound Effects Device",pascal:"CurrentAudioSoundEffectsDevice",token:"%AudioSoundEffectsDevice%"},{human:"Current Audio Sound Effects Device UID",pascal:"CurrentAudioSoundEffectsDeviceUID",token:"%AudioSoundEffectsDeviceUID%"},{human:"Current Mouse Location",pascal:"CurrentMouseLocation",token:"%CurrentMouse%"},{human:"Current Track Album",pascal:"CurrentTrackAlbum",token:"%CurrentTrack%album%"},{human:"Current Track Artist",pascal:"CurrentTrackArtist",token:"%CurrentTrack%artist%"},{human:"Current Track Name",pascal:"CurrentTrackName",token:"%CurrentTrack%name%"},{human:"Current Track Rating",pascal:"CurrentTrackRating",token:"%CurrentTrack%ratingstars%"},{human:"Delete (Hide a Variable)",pascal:"Delete",token:"%Delete%"},{human:"Executing Macro",pascal:"ExecutingMacro",token:"%ExecutingMacro%"},{human:"Executing Macro Group",pascal:"ExecutingMacroGroup",token:"%ExecutingMacroGroup%"},{human:"Executing Macro Group UUID",pascal:"ExecutingMacroGroupUUID",token:"%ExecutingMacroGroupUUID%"},{human:"Executing Macro UUID",pascal:"ExecutingMacroUUID",token:"%ExecutingMacroUUID%"},{human:"Executing This Macro",pascal:"ExecutingThisMacro",token:"%ExecutingThisMacro%"},{human:"Executing This Macro Group",pascal:"ExecutingThisMacroGroup",token:"%ExecutingThisMacroGroup%"},{human:"Executing This Macro Group UUID",pascal:"ExecutingThisMacroGroupUUID",token:"%ExecutingThisMacroGroupUUID%"},{human:"Executing This Macro UUID",pascal:"ExecutingThisMacroUUID",token:"%ExecutingThisMacroUUID%"},{human:"Find Pasteboard",pascal:"FindPasteboard",token:"%FindPasteboard%"},{human:"Finder Insertion Location Path",pascal:"FinderInsertionLocationPath",token:"%FinderInsertionLocation%"},{human:"First Screen Frame",pascal:"FirstScreenFrame",token:"%Screen%1%"},{human:"Formatted (ICU) Date Time",pascal:"FormattedICUDateTime",token:"%ICUDateTime%EEE, MMM d, yyyy h:mm%"},{human:"Formatted (ICU) Date Time For",pascal:"FormattedICUDateTimeFor",token:"%ICUDateTimeFor%NOW()+20%EEE, MMM d, yyyy h:mm%"},{human:"Formatted (ICU) Date Time Minus",pascal:"FormattedICUDateTimeMinus",token:"%ICUDateTimeMinus%3*7%Days%EEE, MMM d, yyyy h:mm%"},{human:"Formatted (ICU) Date Time Plus",pascal:"FormattedICUDateTimePlus",token:"%ICUDateTimePlus%3*7%Days%EEE, MMM d, yyyy h:mm%"},{human:"Formatted Calculation",pascal:"FormattedCalculation",token:"%CalculateFormat%1+2%#,##0.00#%"},{human:"Front Application Bundle ID",pascal:"FrontApplicationBundleID",token:"%ApplicationBundleID%1%"},{human:"Front Application Long Version",pascal:"FrontApplicationLongVersion",token:"%ApplicationLongVersion%1%"},{human:"Front Application Name",pascal:"FrontApplicationName",token:"%Application%1%"},{human:"Front Application Path",pascal:"FrontApplicationPath",token:"%ApplicationPath%1%"},{human:"Front Application Version",pascal:"FrontApplicationVersion",token:"%ApplicationVersion%1%"},{human:"Front Browser Bundle ID",pascal:"FrontBrowserBundleID",token:"%FrontBrowserBundleID%"},{human:"Front Browser Document Title",pascal:"FrontBrowserDocumentTitle",token:"%FrontBrowserTitle%"},{human:"Front Browser Document URL",pascal:"FrontBrowserDocumentURL",token:"%FrontBrowserURL%"},{human:"Front Browser Field",pascal:"FrontBrowserField",token:"%FrontBrowserField%document.forms[0][0]%"},{human:"Front Browser JavaScript",pascal:"FrontBrowserJavaScript",token:"%FrontBrowserJavaScript%document.forms[0].innerHTML%"},{human:"Front Browser Long Version",pascal:"FrontBrowserLongVersion",token:"%FrontBrowserLongVersion%"},{human:"Front Browser Name",pascal:"FrontBrowserName",token:"%FrontBrowserName%"},{human:"Front Browser Path",pascal:"FrontBrowserPath",token:"%FrontBrowserPath%"},{human:"Front Browser Ready State",pascal:"FrontBrowserReadyState",token:"%FrontBrowserReadyState%"},{human:"Front Browser Version",pascal:"FrontBrowserVersion",token:"%FrontBrowserVersion%"},{human:"Front Browser Window Name",pascal:"FrontBrowserWindowName",token:"%FrontBrowserWindowName%"},{human:"Front Window Frame",pascal:"FrontWindowFrame",token:"%WindowFrame%1%"},{human:"Front Window Name",pascal:"FrontWindowName",token:"%WindowName%1%"},{human:"Front Window Position",pascal:"FrontWindowPosition",token:"%WindowPosition%1%"},{human:"Front Window Size",pascal:"FrontWindowSize",token:"%WindowSize%1%"},{human:"Google Chrome Bundle ID",pascal:"GoogleChromeBundleID",token:"%ChromeBundleID%"},{human:"Google Chrome Document Title",pascal:"GoogleChromeDocumentTitle",token:"%ChromeTitle%"},{human:"Google Chrome Document URL",pascal:"GoogleChromeDocumentURL",token:"%ChromeURL%"},{human:"Google Chrome Field",pascal:"GoogleChromeField",token:"%ChromeField%document.forms[0][0]%"},{human:"Google Chrome JavaScript",pascal:"GoogleChromeJavaScript",token:"%ChromeJavaScript%document.forms[0].innerHTML%"},{human:"Google Chrome Long Version",pascal:"GoogleChromeLongVersion",token:"%ChromeLongVersion%"},{human:"Google Chrome Name",pascal:"GoogleChromeName",token:"%ChromeName%"},{human:"Google Chrome Path",pascal:"GoogleChromePath",token:"%ChromePath%"},{human:"Google Chrome Ready State",pascal:"GoogleChromeReadyState",token:"%ChromeReadyState%"},{human:"Google Chrome Version",pascal:"GoogleChromeVersion",token:"%ChromeVersion%"},{human:"Google Chrome Window Name",pascal:"GoogleChromeWindowName",token:"%ChromeWindowName%"},{human:"ID of Last Keyboard Maestro Engine Window Opened by This Macro",pascal:"IDOfLastKeyboardMaestroEngineWindowOpenedByThisMacro",token:"%LastWindowID%"},{human:"ID of the Last Aborted Action",pascal:"IDOfTheLastAbortedAction",token:"%LastAbortedActionID%"},{human:"JSON From Dictionary",pascal:"JSONFromDictionary",token:"%JSONFromDictionary%DictionaryName%"},{human:"JSON From Variables",pascal:"JSONFromVariables",token:"%JSONFromVariables%Prefix%"},{human:"JSON Value",pascal:"JSONValue",token:"%JSONValue%VariableName.field(field)[1]%"},{human:"Keyboard Layout Input Source",pascal:"KeyboardLayoutInputSource",token:"%KeyboardLayout%"},{human:"Keyboard Maestro Long Version",pascal:"KeyboardMaestroLongVersion",token:"%KeyboardMaestroLongVersion%"},{human:"Keyboard Maestro Version",pascal:"KeyboardMaestroVersion",token:"%KeyboardMaestroVersion%"},{human:"Linefeed (\\n)",pascal:"Linefeed",token:"%LineFeed%"},{human:"Long Date",pascal:"LongDate",token:"%LongDate%"},{human:"Machine IP Address",pascal:"MachineIPAddress",token:"%MacIPAddress%"},{human:"Machine Name",pascal:"MachineName",token:"%MacName%"},{human:"Machine Unique ID",pascal:"MachineUniqueID",token:"%MacUUID%"},{human:"Macro Name for UUID",pascal:"MacroNameForUUID",token:"%MacroNameForUUID%UUID%"},{human:"Mail BCC Recipients",pascal:"MailBCCRecipients",token:"%MailBCCRecipients%"},{human:"Mail CC Recipients",pascal:"MailCCRecipients",token:"%MailCCRecipients%"},{human:"Mail Contents",pascal:"MailContents",token:"%MailContents%"},{human:"Mail Raw Source",pascal:"MailRawSource",token:"%MailRawSource%"},{human:"Mail Recipients",pascal:"MailRecipients",token:"%MailRecipients%"},{human:"Mail Reply To",pascal:"MailReplyTo",token:"%MailReplyTo%"},{human:"Mail Sender",pascal:"MailSender",token:"%MailSender%"},{human:"Mail Subject",pascal:"MailSubject",token:"%MailSubject%"},{human:"Mail To Recipients",pascal:"MailToRecipients",token:"%MailToRecipients%"},{human:"Main Screen Frame",pascal:"MainScreenFrame",token:"%Screen%Main%"},{human:"Main Screen Possible Resolutions (array of resolutions)",pascal:"MainScreenPossibleResolutions",token:"%ScreenResolutions%Main%"},{human:"Main Screen Resolution (width,height,pixelwidth,pixelheight,refresh)",pascal:"MainScreenResolution",token:"%ScreenResolution%Main%"},{human:"Main Screen Visible Frame",pascal:"MainScreenVisibleFrame",token:"%ScreenVisible%Main%"},{human:"Music Player State (stopped/playing/paused/fast forwarding/rewinding/not running)",pascal:"MusicPlayerState",token:"%MusicPlayerState%"},{human:"Named Clipboard",pascal:"NamedClipboard",token:"%NamedClipboard%A Named Clipboard%"},{human:"Named Clipboard Flavors",pascal:"NamedClipboardFlavors",token:"%NamedClipboardFlavors%A Named Clipboard%"},{human:"Network Location",pascal:"NetworkLocation",token:"%NetworkLocation%"},{human:"Number Date",pascal:"NumberDate",token:"%NumberDate%"},{human:"Opaque ID of the Current Execution Instance",pascal:"OpaqueIDOfTheCurrentExecutionInstance",token:"%ExecutingInstance%"},{human:"Option-Return (Insert Text by Typing Only)",pascal:"OptionReturn",token:"%OptionReturn%"},{human:"Past Clipboard",pascal:"PastClipboard",token:"%PastClipboard%1%"},{human:"Past Clipboard Flavors",pascal:"PastClipboardFlavors",token:"%PastClipboardFlavors%1%"},{human:"Position Cursor (Insert Text Only)",pascal:"PositionCursor",token:"%|%"},{human:"Previous Application Name",pascal:"PreviousApplicationName",token:"%Application%2%"},{human:"Prompt for Snippet Placeholder (Default from Variable)",pascal:"PromptForSnippetPlaceholderDefaultFromVariable",token:"%Ask20:VarName%"},{human:"Prompt for Snippet Placeholder (Default Text)",pascal:"PromptForSnippetPlaceholderDefaultText",token:"%Ask20:Default%"},{human:"Return (\\r)",pascal:"Return",token:"%Return%"},{human:"Safari Bundle ID",pascal:"SafariBundleID",token:"%SafariBundleID%"},{human:"Safari Document Title",pascal:"SafariDocumentTitle",token:"%SafariTitle%"},{human:"Safari Document URL",pascal:"SafariDocumentURL",token:"%SafariURL%"},{human:"Safari Field",pascal:"SafariField",token:"%SafariField%document.forms[0][0]%"},{human:"Safari JavaScript",pascal:"SafariJavaScript",token:"%SafariJavaScript%document.forms[0].innerHTML%"},{human:"Safari Long Version",pascal:"SafariLongVersion",token:"%SafariLongVersion%"},{human:"Safari Name",pascal:"SafariName",token:"%SafariName%"},{human:"Safari Path",pascal:"SafariPath",token:"%SafariPath%"},{human:"Safari Ready State",pascal:"SafariReadyState",token:"%SafariReadyState%"},{human:"Safari Version",pascal:"SafariVersion",token:"%SafariVersion%"},{human:"Safari Window Name",pascal:"SafariWindowName",token:"%SafariWindowName%"},{human:"Second Screen Frame",pascal:"SecondScreenFrame",token:"%Screen%2%"},{human:"Short Date",pascal:"ShortDate",token:"%ShortDate%"},{human:"Space",pascal:"Space",token:"%Space%"},{human:"Success Result of Last Action",pascal:"SuccessResultOfLastAction",token:"%ActionResult%"},{human:"System Clipboard",pascal:"SystemClipboard",token:"%SystemClipboard%"},{human:"System Clipboard Flavors",pascal:"SystemClipboardFlavors",token:"%SystemClipboardFlavors%"},{human:"System Long Version",pascal:"SystemLongVersion",token:"%SystemLongVersion%"},{human:"System Version",pascal:"SystemVersion",token:"%SystemVersion%"},{human:"System Volume",pascal:"SystemVolume",token:"%SystemVolume%"},{human:"Tab (\\t)",pascal:"Tab",token:"%Tab%"},{human:"The Last Alert Button Selected",pascal:"TheLastAlertButtonSelected",token:"%AlertButton%"},{human:"The Last Custom HTML Result",pascal:"TheLastCustomHTMLResult",token:"%HTMLResult%"},{human:"The Last Found Image",pascal:"TheLastFoundImage",token:"%FoundImage%"},{human:"The Last Prompt Button Selected",pascal:"TheLastPromptButtonSelected",token:"%PromptButton%"},{human:"The Macro Name of the Specified Instance",pascal:"TheMacroNameOfTheSpecifiedInstance",token:"%ExecutingInstanceName%"},{human:"The Modifiers Used When Completing a Prompt With List Action",pascal:"TheModifiersUsedWhenCompletingAPromptWithListAction",token:"%PromptWithListModifiers%"},{human:"The Path of the Front Window’s Document",pascal:"ThePathOfTheFrontWindowDocument",token:"%FrontDocumentPath%"},{human:"The Path of the Selected Finder Item",pascal:"ThePathOfTheSelectedFinderItem",token:"%FinderSelection%"},{human:"The Paths of the Selected Finder Items",pascal:"ThePathsOfTheSelectedFinderItems",token:"%FinderSelections%"},{human:"The Text Entered in a Paste by Name Action",pascal:"TheTextEnteredInAPasteByNameAction",token:"%PasteByNameText%"},{human:"The Text Entered in a Prompt With List Action",pascal:"TheTextEnteredInAPromptWithListAction",token:"%PromptWithListText%"},{human:"The Text Entered in a Select Menu by Name Action",pascal:"TheTextEnteredInASelectMenuByNameAction",token:"%SelectMenuByNameText%"},{human:"Time",pascal:"Time",token:"%ShortTime%"},{human:"Time With Seconds",pascal:"TimeWithSeconds",token:"%LongTime%"},{human:"Tripped Trigger Clipboard Flavors",pascal:"TrippedTriggerClipboardFlavors",token:"%TriggerClipboardFlavors%"},{human:"Tripped Trigger Clipboard Value",pascal:"TrippedTriggerClipboardValue",token:"%TriggerClipboard%"},{human:"Tripped Trigger Text",pascal:"TrippedTriggerText",token:"%Trigger%"},{human:"Tripped Trigger Type",pascal:"TrippedTriggerType",token:"%TriggerBase%"},{human:"Tripped Trigger Value",pascal:"TrippedTriggerValue",token:"%TriggerValue%"},{human:"User Home Directory",pascal:"UserHomeDirectory",token:"%UserHome%"},{human:"User Login ID",pascal:"UserLoginID",token:"%UserLoginID%"},{human:"User Name",pascal:"UserName",token:"%UserName%"},{human:"Wireless Network Name(s)",pascal:"WirelessNetworkNames",token:"%WirelessNetwork%"}],e=!0}catch(t){throw new Error("Could not locate token mapping data file")}}const n=new Map,r=new Map,o=new Map;for(const e of t)n.set(e.human,e),r.set(e.pascal,e),o.set(e.token,e);ut={lookupByHuman:n,lookupByPascal:r,lookupByToken:o}}catch(t){const e=t instanceof Error?t.message:String(t);console.warn("[km.token.lookup] Failed to load token data:",e),ut={lookupByHuman:new Map,lookupByPascal:new Map,lookupByToken:new Map}}}();const{lookupByHuman:o,lookupByPascal:i,lookupByToken:a}=ut,s=null!==(r=null!==(n=o.get(t))&&void 0!==n?n:i.get(t))&&void 0!==r?r:a.get(t);if(!s)throw new Error(`Unknown Keyboard Maestro token: "${t}"`);if(e)return s[e];const l={...s};return t===s.human&&delete l.human,t===s.pascal&&delete l.pascal,t===s.token&&delete l.token,l},exports.normalizeAppleScriptShortcut=Vt,exports.notify=ct,exports.queries=It,exports.runMacro=function({macroId:t,parameter:e=""}){const n="object"==typeof e?JSON.stringify(e):String(e),r=`\n(function () {\n  var kme = Application('Keyboard Maestro Engine');\n  var result = kme.doScript('${t}', { withParameter: '${o=n,o.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\n/g,"\\n").replace(/\r/g,"\\r")}' });\n  return (result !== undefined && result !== null) ? String(result) : '';\n})();`;var o;console.log(C.magenta(`[kmjs.runMacro] Macro ID: ${t}`)),console.log(C.gray(`[kmjs.runMacro] Param: ${n}`)),console.log(C.gray(`[kmjs.runMacro] JXA →\n${r}`)),M();const i=v(),{status:a,stdout:s,stderr:l,error:c}=i("osascript",["-l","JavaScript","-e",r],{encoding:"utf8"});if(c)throw console.error(C.red("[kmjs.runMacro] spawnSync error:"),c),c;if(0!==a)throw console.error(C.red(`[kmjs.runMacro] osascript stderr:\n${l}`)),new Error(`osascript failed: ${l.trim()}`);const u=E(w());if(u.length){const t=C.bgRed(" ".repeat(48));console.log(),console.log(t),console.log(C.whiteBright.bgRed.bold("[kmjs.runMacro] Engine Errors:")),u.forEach((t,e)=>{const n=C.redBright("  • "),r=e%2==0?C.yellowBright.bold(t):C.whiteBright.bold(t);console.log(n+r)}),console.log(t),console.log()}return console.log(C.green(`[kmjs.runMacro] stdout: ${s.trim()}`)),s.trim()},exports.runQuery=At,exports.runVirtualMacro=q,exports.searchReplaceInText=We,exports.setVariable=it,exports.stripRtfToPlainText=Z,exports.updateStyledTextInXml=function(t,e){var n,r;const o=z.exec(t);if(!o)return console.warn(C.yellow("[utils.styledText.update] <StyledText><data>...</data> not found in given XML.")),t;const i=null!==(r=null===(n=o.groups)||void 0===n?void 0:n.data)&&void 0!==r?r:"",{rtf:a}=_(i),s=e(a),l=H(s,!0);let c=(u=t,d=o.index,p=o[0].length,g=["<key>StyledText</key>","<data>",l,"</data>"].join("\n"),u.slice(0,d)+g+u.slice(d+p));var u,d,p,g;return c=function(t,e){var n;const r=Y.exec(t);if(!r)return console.warn(C.yellow("[utils.styledText.update] <key>Text</key> not found. Leaving XML untouched.")),t;const{0:o,groups:i}=r,a=null!==(n=null==i?void 0:i.text)&&void 0!==n?n:"",s=$(e),l=o.replace(a,s);return t.replace(o,l)}(c,Z(s)),c},exports.xmlToJson=je;
